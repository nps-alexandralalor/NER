---
title: "QAQC GRCA MetaData"
author: "Alexandra Lalor"
output:
  html_document:
    theme: readable
    highlight: 
    toc: yes
    toc_depth: 3
    toc_float:
      smooth_scroll: yes
    code_download: true
  pdf_document:
    toc: yes
    toc_depth: '3'
---

# Before Starting

### Setup

```{r setup, include=FALSE}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warnings = FALSE, message = FALSE)
```

```{r install packages, include=FALSE}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("Rtools")
# install.packages("janitor")
# install.packages("condformat")
# install.packages("knitr")
# install.packages("here")
```

```{r load packages, include=FALSE}
## Load Packages

# tidyverse and dplyr have lots of useful functions for data cleaning
library(tidyverse)
library(dplyr)
library(plyr)
# janitor has functions to find duplicates
library(janitor)
# writexl is used to create excel output files
library(writexl)
# condformat is used to format excel output files
library(condformat)
# knitr is used to create output files from R Markdown
library(knitr)
# "here" helps you easily find and reference your working directory
library(here)
```

### Create Function

```{r}
# Blank data frame
errors_blank_meta <- data.frame("SavedQuery" = "", "Macroplot" = "", "Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "")

# QAQC function
qaqc_meta <- function(data, query, query_message, values_check) {
  
  # Check if there is data to QAQC
  if(nrow(data) == 0) {
  # If there is no data, default to "No Error" data frame
  errors <- errors_blank_meta %>%
    mutate(SavedQuery = query,
           Error = "No Error")
  # If there is data, perform error check
} else {
  
  # Use relevant dataset to look for errors
  errors <- data %>%  
    # Add columns relevant to error checking
           # Populate the "SavedQuery" column with the query name
    mutate("SavedQuery" = query, 
           # Populate the "Error" column with the query message and relevant data
           "Error" = paste(query_message, "=", values_data),
           # Create a blank "Fixed" column
           "Fixed" = "",
           # Create a blank "Explanation" column
           "Explanation" = "",
           # Create a blank "Queryers" column
           "Queryers" = "") %>%   
    # Filter for data which is "false" (data does not match valid conditions)
    # NA values are treated as "false" (missing data is not valid)
    filter(!(values_check %>% replace_na(FALSE))) %>%   
    # Select relevant columns to view errors
    select("SavedQuery", "Macroplot", "Error", "Fixed", "Explanation", "Queryers")
  
  # Next, check if there are duplicate errors
  errors_temp <- errors %>% 
    get_dupes(SavedQuery, Macroplot, Error)
  # Merge duplicate errors
  errors <- unique(merge(errors, errors_temp, all = T))
  # If duplicate errors exist, add number of duplicates to error message
  errors <- errors %>% 
    mutate(Error = ifelse(is.na(dupe_count), Error, paste0("(x", dupe_count, ") ", Error))) %>% 
    select(!"dupe_count")
}
  
  # Check if there are no errors
  if (nrow(errors) == 0) {  
    # If there are no errors, default to "No Error" data frame
    errors <- errors_blank_meta %>%
      mutate(SavedQuery = query,
             Error = "No Error")
    # If there are errors, keep error log you just created
  } else {   
    errors <- errors
  }
}
```

### Adjust File Paths

```{r import data, include=FALSE}
# Identify working directory.
here()

# designate target park(s)
target_park <- "RICH"

# Load in data.
path_file <- "C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/Exports/_metadata/"
path_data <- paste0(path_file, target_park, "/")
path_errors <- paste0(here(), "/output/errors/")
path_errors_name <- paste0(target_park, " Metadata QAQC Errors")
```

### Load Data

```{r load data, include=FALSE}
## Load Data
MacroplotReport <- read.csv(paste0(path_data, target_park, "_", "MacroplotReport.csv"))
ProjectUnitReport <- read.csv(paste0(path_data, target_park, "_", "ProjectUnitAssignmentReport.csv"))
SampleEventReport <- read.csv(paste0(path_data, target_park, "_", "SampleEventReport.csv"))
```

### Clean Data

```{r}
#### Macroplot Report
# The Macroplot Report contains information on both plot metadata and sample event history. Separate these into 2 tables.
  
MacroplotReport_MetaData <- MacroplotReport %>%
  # remove trailing/leading whitespace
  mutate(across(where(is.character), str_trim)) %>%
  # separate tables
  mutate(SampleEventDate = ifelse(SampleEventDate == "", NA, SampleEventDate)) %>% 
  filter(is.na(SampleEventDate)) %>%
  # separate Date columns into Date and Time columns
  separate(DateIn, sep = " ", into = c("DateIn", "DateInTime")) %>%
  # reformate Date columns
  mutate(DateIn = as.Date(DateIn, "%m/%d/%Y")) %>%
  # separate Date columns into Year, Month, and Day columns
  separate(DateIn, sep = "-", into = c("DateIn_Year", "DateIn_Month", "DateIn_Day"), remove = FALSE) %>%
  # remove unnecessary Date columns
  select(!c(DateInTime, DateIn_Month, DateIn_Day)) %>%
  select(!c(SampleEventDate, SampleEventTeam, SampleEventComment, MonStatusOrd, LegacyMonStatus, MonStatus))

MacroplotReport_SampleEvents <- MacroplotReport %>%
  # remove trailing/leading whitespace
  mutate(across(where(is.character), str_trim)) %>%
  # separate tables
  mutate(SampleEventDate = ifelse(SampleEventDate == "", NA, SampleEventDate)) %>% 
  filter(!is.na(SampleEventDate)) %>%
  # separate Date columns into Date and Time columns
  separate(SampleEventDate, sep = " ", into = c("SampleEventDate", "SampleEventTime")) %>%
  # reformate Date columns
  mutate(SampleEventDate = as.Date(SampleEventDate, "%m/%d/%Y")) %>%
  # separate Date columns into Year, Month, and Day columns
  separate(SampleEventDate, sep = "-", into = c("SampleEventDate_Year", "SampleEventDate_Month", "SampleEventDate_Day"), remove = FALSE) %>%
  # remove unnecessary Date columns
  select(!c(SampleEventTime, SampleEventDate_Month, SampleEventDate_Day)) %>%
  select(c(Macroplot, SampleEventDate, SampleEventTeam, SampleEventComment, MonStatusOrd, LegacyMonStatus, MonStatus))


#### Sample Event Report
# The Sample Event Report has different column names as the Macroplot Report, but contains the same information. Make column names consistent.

SampleEventReport <- SampleEventReport %>%
  # remove trailing/leading whitespace
  mutate(across(where(is.character), str_trim)) %>%
  # make column names consistent
  mutate(Macroplot = MacroPlot_Name,
         LegacyMonitoringStatus = SampleEvent_LegacyMonitoringStatus,
         MonStatus = MonitoringStatus_Name,
         ProjectUnit = ProjectUnit_Name,
         SampleEventDate = SampleEvent_Date) %>%
  # separate Date columns into Date and Time columns
  separate(SampleEventDate, sep = " ", into = c("SampleEventDate", "SampleEventTime")) %>%
  # reformate Date columns
  mutate(SampleEventDate = as.Date(SampleEventDate, "%m/%d/%Y")) %>%
  # separate Date columns into Year, Month, and Day columns
  separate(SampleEventDate, sep = "-", into = c("SampleEventDate_Year", "SampleEventDate_Month", "SampleEventDate_Day"), remove = FALSE) %>%
  # remove unnecessary Date columns
  select(!c(SampleEventTime, SampleEventDate_Month, SampleEventDate_Day)) %>%
  select(!c(MacroPlot_Name, SampleEvent_LegacyMonitoringStatus, MonitoringStatus_Name, ProjectUnit_Name, SampleEvent_Date))
```

# Macroplot Report

### Setup

[Problem:]{.underline} Macroplot Report is missing information related to plot setup

[Procedure:]{.underline}

-   Check that Macroplot is not blank

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Setup"
query_message <- "Macroplot" 
values_data <- data$Macroplot
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_Macroplot1 <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Purpose is not blank and is written correctly

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Setup"
query_message <- "Purpose" 
values_data <- data$Purpose
values_valid <- c("Fire Effects Monitoring")
values_check <- values_data %in% values_valid

# Identify errors
errors_MacroplotReport_Purpose <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Type = Forest or Grassland

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Setup"
query_message <- "Type" 
values_data <- data$Type
values_valid <- c("Forest", "Grassland")
values_check <- values_data %in% values_valid

# Identify errors
errors_MacroplotReport_Type <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that DateIn is not blank

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Setup"
query_message <- "Date In" 
values_data <- data$DateIn
values_valid <- is.na(data$DateIn)
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_DateIn <- qaqc_meta(data, query, query_message, values_check)
```

#### Combine Setup Errors

```{r}
# Combine
errors_MacroplotReport_Setup <- unique(rbind(errors_MacroplotReport_Macroplot1, errors_MacroplotReport_Purpose, errors_MacroplotReport_Type, errors_MacroplotReport_DateIn))

remove(errors_MacroplotReport_Macroplot1, errors_MacroplotReport_Purpose, errors_MacroplotReport_Type, errors_MacroplotReport_DateIn)

if(nrow(errors_MacroplotReport_Setup) > 1) {
  errors_MacroplotReport_Setup <- errors_MacroplotReport_Setup %>%
    filter(Error != "No Error")
} else {
  errors_MacroplotReport_Setup <- errors_MacroplotReport_Setup}
```

### Location

[Problem:]{.underline} Macroplot Report is missing information related to plot geographic location

[Procedure:]{.underline}

-   Check that Latitude is not blank

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Location"
query_message <- "Latitude" 
values_data <- data$Latitude
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_Latitude <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Longitude is not blank

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Location"
query_message <- "Longitude" 
values_data <- data$Longitude
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_Longitude <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that UTM_X (easting) has 6 digits

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Location"
query_message <- "UTM_X (easting) should have 6 digits. Digits" 
values_data <- nchar(data$UTM_X)
values_valid <- 6
values_check <- values_data == values_valid

# Identify errors
errors_MacroplotReport_UTM_X <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that UTM_Y (northing) has 7 digits

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Location"
query_message <- "UTM_Y (northing) should have 7 digits. Digits" 
values_data <- nchar(data$UTM_Y)
values_valid <- 7
values_check <- values_data == values_valid

# Identify errors
errors_MacroplotReport_UTM_Y <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that UTM_Zone = 17N, 18N, or 19N

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Location"
query_message <- "UTM_Zone" 
values_data <- data$UTM_Zone
values_valid <- c("17N", "18N", "19N")
values_check <- values_data %in% values_valid

# Identify errors
errors_MacroplotReport_UTM_Zone <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Datum = NAD83

```{r}
# Set parameters 
data <- MacroplotReport_MetaData
query <- "Macroplot Report - Location"
query_message <- "Datum" 
values_data <- data$Datum
values_valid <- c("NAD83")
values_check <- values_data %in% values_valid

# Identify errors
errors_MacroplotReport_Datum <- qaqc_meta(data, query, query_message, values_check)
```

#### Combine Location Errors

```{r}
# Combine
errors_MacroplotReport_Location <- unique(rbind(errors_MacroplotReport_Latitude, errors_MacroplotReport_Longitude, errors_MacroplotReport_UTM_X, errors_MacroplotReport_UTM_Y, errors_MacroplotReport_UTM_Zone, errors_MacroplotReport_Datum))

remove(errors_MacroplotReport_Latitude, errors_MacroplotReport_Longitude, errors_MacroplotReport_UTM_X, errors_MacroplotReport_UTM_Y, errors_MacroplotReport_UTM_Zone, errors_MacroplotReport_Datum)

if(nrow(errors_MacroplotReport_Location) > 1) {
  errors_MacroplotReport_Location <- errors_MacroplotReport_Location %>%
    filter(Error != "No Error")
} else {
  errors_MacroplotReport_Location <- errors_MacroplotReport_Location}
```

### Position

[Problem:]{.underline} Macroplot Report is missing information related to plot position on the landscape

[Procedure:]{.underline}

-   Check that Elevation is not blank

```{r}
# # Set parameters 
# data <- MacroplotReport_MetaData
# query <- "Macroplot Report - Position"
# query_message <- "Elevation" 
# values_data <- data$Elevation
# values_valid <- ""
# values_check <- values_data != values_valid
# 
# # Identify errors
# errors_MacroplotReport_Elevation <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that ElevationUnits = feet

```{r}
# # Set parameters 
# data <- MacroplotReport_MetaData
# query <- "Macroplot Report - Position"
# query_message <- "Elevation Units" 
# values_data <- data$ElevationUnits
# values_valid <- c("feet")
# values_check <- values_data %in% values_valid
# 
# # Identify errors
# errors_MacroplotReport_ElevationUnits <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Azimuth values are reasonable

```{r}
# # Set parameters 
# data <- MacroplotReport_MetaData
# query <- "Macroplot Report - Position"
# query_message <- "Azimuth" 
# values_data <- data$Azimuth
# values_valid <- seq(0, 359, by = 1)
# values_check <- values_data %in% values_valid
# 
# # Identify errors
# errors_MacroplotReport_Azimuth <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Aspect values are reasonable

```{r}
# # Set parameters 
# data <- MacroplotReport_MetaData
# query <- "Macroplot Report - Position"
# query_message <- "Aspect" 
# values_data <- data$Aspect
# values_valid <- seq(0, 359, by = 1)
# values_check <- values_data %in% values_valid
# 
# # Identify errors
# errors_MacroplotReport_Aspect <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that SlopeHill values are reasonable

```{r}
# # Set parameters 
# data <- MacroplotReport_MetaData
# query <- "Macroplot Report - Position"
# query_message <- "Slope Hill" 
# values_data <- data$SlopeHill
# values_valid <- seq(0, 40, by = 1)
# values_check <- values_data %in% values_valid
# 
# # Identify errors
# errors_MacroplotReport_SlopeHill <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that SlopeTransect values are reasonable

```{r}
# # Set parameters 
# data <- MacroplotReport_MetaData
# query <- "Macroplot Report - Position"
# query_message <- "Slope Transect" 
# values_data <- data$SlopeTransect
# values_valid <- seq(0, 40, by = 1)
# values_check <- values_data %in% values_valid
# 
# # Identify errors
# errors_MacroplotReport_SlopeTransect <- qaqc_meta(data, query, query_message, values_check)
```

#### Combine Position Errors

```{r}
# # Combine
# errors_MacroplotReport_Position <- unique(rbind(errors_MacroplotReport_Elevation, errors_MacroplotReport_ElevationUnits, errors_MacroplotReport_Azimuth, errors_MacroplotReport_Aspect, errors_MacroplotReport_SlopeHill, errors_MacroplotReport_SlopeTransect))
# 
# remove(errors_MacroplotReport_Elevation, errors_MacroplotReport_ElevationUnits, errors_MacroplotReport_Azimuth, errors_MacroplotReport_Aspect, errors_MacroplotReport_SlopeHill, errors_MacroplotReport_SlopeTransect)
# 
# if(nrow(errors_MacroplotReport_Position) > 1) {
#   errors_MacroplotReport_Position <- errors_MacroplotReport_Position %>%
#     filter(Error != "No Error")
# } else {
#   errors_MacroplotReport_Position <- errors_MacroplotReport_Position}
```

### Sample Events

[Problem:]{.underline} Macroplot Report is missing information related to sample events

[Procedure:]{.underline}

-   Check that Macroplot is not blank

```{r}
# Set parameters 
data <- MacroplotReport_SampleEvents
query <- "Macroplot Report - Sample Events"
query_message <- "Macroplot" 
values_data <- data$Macroplot
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_Macroplot2 <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that SampleEventDate is not blank

```{r}
# Set parameters 
data <- MacroplotReport_SampleEvents
query <- "Macroplot Report - Sample Events"
query_message <- "Sample Event Date" 
values_data <- data$SampleEventDate
values_valid <- is.na(data$SampleEventDate)
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_SampleEventDate <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that MonStatusOrd is not blank

```{r}
# Set parameters 
data <- MacroplotReport_SampleEvents
query <- "Macroplot Report - Sample Events"
query_message <- "Monitoring Status Order" 
values_data <- data$MonStatusOrd
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_MonStatusOrd <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that MonStatus is not blank

```{r}
# Set parameters 
data <- MacroplotReport_SampleEvents
query <- "Macroplot Report - Sample Events"
query_message <- "Monitoring Status" 
values_data <- data$MonStatus
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_MonStatus <- qaqc_meta(data, query, query_message, values_check)
```

#### Combine Sample Event Errors

```{r}
# Combine
errors_MacroplotReport_SampleEvent <- unique(rbind(errors_MacroplotReport_Macroplot2, errors_MacroplotReport_SampleEventDate, errors_MacroplotReport_MonStatusOrd, errors_MacroplotReport_MonStatus))

remove(errors_MacroplotReport_Macroplot2, errors_MacroplotReport_SampleEventDate, errors_MacroplotReport_MonStatusOrd, errors_MacroplotReport_MonStatus)

if(nrow(errors_MacroplotReport_SampleEvent) > 1) {
  errors_MacroplotReport_SampleEvent <- errors_MacroplotReport_SampleEvent %>%
    filter(Error != "No Error")
} else {
  errors_MacroplotReport_SampleEvent <- errors_MacroplotReport_SampleEvent}
```

### Combine Macroplot Report Errors

```{r}
errors_MacroplotReport <- rbind(errors_MacroplotReport_Setup, errors_blank_meta, errors_MacroplotReport_Location, errors_blank_meta, errors_MacroplotReport_SampleEvent)

remove(errors_MacroplotReport_Setup, errors_MacroplotReport_Location, errors_MacroplotReport_SampleEvent)
```

# Project Unit Assignment Report

[Problem:]{.underline} Project Unit Assignment Report is missing information

[Procedure:]{.underline}

-   Check that Macroplot is not blank

```{r}
# Set parameters 
data <- ProjectUnitReport
query <- "Project Unit Report"
query_message <- "Macroplot" 
values_data <- data$Macroplot
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_ProjectUnitReport_Macroplot <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that ProjectUnit is not blank

```{r}
# Set parameters 
data <- ProjectUnitReport
query <- "Project Unit Report"
query_message <- "Project Unit" 
values_data <- data$ProjectUnit
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_ProjectUnitReport_ProjectUnit <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Multi_PU = N. If Multi_PU = Y, you will need to isolate which Project Unit contains the primary data for the analysis of interest.

```{r}
# Set parameters 
data <- ProjectUnitReport
query <- "Project Unit Report"
query_message <- "Multi Project Units" 
values_data <- data$Multi_PU
values_valid <- c("N")
values_check <- values_data %in% values_valid

# Identify errors
errors_ProjectUnitReport_MultiPU <- qaqc_meta(data, query, query_message, values_check)
```

### Combine Project Unit Report Errors

```{r}
errors_ProjectUnitReport <- unique(rbind(errors_ProjectUnitReport_Macroplot, errors_ProjectUnitReport_ProjectUnit, errors_ProjectUnitReport_MultiPU))

remove(errors_ProjectUnitReport_Macroplot, errors_ProjectUnitReport_ProjectUnit, errors_ProjectUnitReport_MultiPU)

if(nrow(errors_ProjectUnitReport) > 1) {
  errors_ProjectUnitReport <- errors_ProjectUnitReport %>%
    filter(Error != "No Error")
} else {
  errors_ProjectUnitReport <- errors_ProjectUnitReport}
```

# Sample Event Report

[Problem:]{.underline} Sample Event Report is missing information or is inconsistent with the Macroplot Report

[Procedure:]{.underline}

-   Check that AdministrationUnit_Name is correct

```{r}
# Set parameters 
data <- SampleEventReport
query <- "Sample Event Report"
query_message <- "Administration Unit Name" 
values_data <- data$AdministrationUnit_Name
values_valid <- target_park
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_AdministrationUnit <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Protocols contains the correct information

```{r}
# Set parameters 
data <- SampleEventReport %>% 
  filter(!MonStatus %in% c("Burn", "Herbicide", "Mow", "Mechanical"))
query <- "Sample Event Report"
query_message <- paste0("Date = ", data$SampleEventDate, ". Read = ", data$MonStatus, ". Protocol")
values_data <- data$Protocol
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_SampleEventReport_Protocols <- qaqc_meta(data, query, query_message, values_check)
```

-   Check that Visited = Y for each relevant monitoring status (excluding disturbance events: Burn, Herbicide, Mow, Mechanical)

```{r}
# Set parameters 
data <- SampleEventReport %>% 
  filter(!MonStatus %in% c("Burn", "Herbicide", "Mow", "Mechanical"))
query <- "Sample Event Report"
query_message <- paste0("Date = ", data$SampleEventDate, ". Read = ", data$MonStatus, ". Visited")
values_data <- data$Visited
values_valid <- "Y"
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_Visited_1 <- qaqc_meta(data, query, query_message, values_check)
```

```{r}
# Set parameters 
data <- SampleEventReport %>% 
  filter(MonStatus %in% c("Burn", "Herbicide", "Mow", "Mechanical"))
query <- "Sample Event Report"
query_message <- paste0("Date = ", data$SampleEventDate, ". Read = ", data$MonStatus, ". Visited")
values_data <- data$Visited
values_valid <- "N"
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_Visited_2 <- qaqc_meta(data, query, query_message, values_check)
```

-   Compare unique MonStatus between both the Sample Event Report and Metadata Report. Isolate differences between reports.

```{r}
# Compare MonStatus between Sample Event Report and Metadata Report, isolate differences
data_temp1 <- SampleEventReport %>% 
  select(Macroplot, SampleEventDate, MonStatus) %>% 
  unique()

data_temp2 <- MacroplotReport_SampleEvents %>% 
  select(Macroplot, SampleEventDate, MonStatus) %>% 
  filter(!is.na(SampleEventDate)) %>% 
  unique()

data_temp <- setdiff(data_temp1, data_temp2) %>% 
  mutate(MonStatusError = MonStatus) %>% 
  filter(MonStatus != "") %>% 
  select(!MonStatus)
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(MacroplotReport_SampleEvents, data_temp, by = c("Macroplot", "SampleEventDate"), all = T)
data$MonStatusError[is.na(data$MonStatusError)] <- ""
data <- data %>% 
  filter(MonStatusError != "")
query <- "MonStatus"
query_message <- paste0("MacroplotReport MonStatus = ", data$MonStatus, ". ", "SampleEventReport MonStatus") 
values_data <- data$MonStatusError
values_valid <- data$MonStatus
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_MonStatus <- qaqc_meta(data, query, query_message, values_check)
```

### Combine Sample Event Report Errors

```{r}
errors_SampleEventReport <- unique(rbind(errors_SampleEventReport_AdministrationUnit, errors_SampleEventReport_Protocols, errors_SampleEventReport_Visited_1, errors_SampleEventReport_Visited_2, errors_SampleEventReport_MonStatus))

remove(errors_SampleEventReport_AdministrationUnit, errors_SampleEventReport_Protocols, errors_SampleEventReport_Visited_1, errors_SampleEventReport_Visited_2, errors_SampleEventReport_MonStatus)

if(nrow(errors_SampleEventReport) > 1) {
  errors_SampleEventReport <- errors_SampleEventReport %>%
    filter(Error != "No Error")
} else {
  errors_SampleEventReport <- errors_SampleEventReport}
```

# ALL ERRORS

```{r}
errors_all <- rbind(errors_MacroplotReport, errors_blank_meta, errors_ProjectUnitReport, errors_blank_meta, errors_SampleEventReport)
```

```{r}
# Create conditional formatting rules
errors_all_cf <- errors_all %>% 
  mutate(Color = ifelse(SavedQuery == "", NA, "Color"))

# Add conditional formating to ouput
errors_all <- condformat(errors_all_cf[1:(nrow(errors_all_cf)), 1:7]) %>%
  rule_fill_discrete(columns = 1:6,
                     expression = (errors_all_cf$Color),
                     colours = c("Color"="#C6E0B4"),
                     na.value = "#FFFFFF") %>%
  select(!c("Color"))
```

```{r}
# Table of results for quick check
#kable(errors_all, "pipe")

# Save as CSV or XLSX 
condformat2excel(errors_all, paste0(path_errors, paste0(target_park, "_errors_metadata_formatted.xlsx")), sheet_name = path_errors_name, overwrite_wb = TRUE)
```

# METADATA REPORT: MERGE AND SAVE

```{r}
#### Merge MacroplotReport_Metadata and MacroplotReport_SampleEvents
MacroplotReport_merge <- merge(MacroplotReport_MetaData, MacroplotReport_SampleEvents, by = c("Macroplot")) %>%
  select(!MonStatusOrd)

#### Filter Sample Event Report for merging
SampleEventReport_merge <- SampleEventReport %>%
  select(!c(Multi_PU, LegacyMonitoringStatus))

#### Merge Macroplot Report and Sample Event Report
MetadataReport <- merge(MacroplotReport_merge, SampleEventReport_merge, by = c("Macroplot", "SampleEventDate", "MonStatus")) %>%
  relocate(AdministrationUnit_Name, .before = Macroplot) %>%
  relocate(ProjectUnit, .before = Purpose) %>%
  relocate(Macroplot, .after = Purpose) %>%
  relocate(SampleEventDate, .after = Visited) %>%
  relocate(MonStatus, .after = LegacyMonStatus) %>%
  relocate(LocatedBy, .before = StartPoint)
```

```{r}
MetadataReport[] <- lapply(MetadataReport, function(x) gsub(",", ";", x))

# save metadata file as csv
write.csv(MetadataReport, paste0(path_data, paste0(target_park, "_MetadataReport.csv")), quote=FALSE, row.names = FALSE, na = "") 
```
