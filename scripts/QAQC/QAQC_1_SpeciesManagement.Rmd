---
title: "QAQC MetaData"
author: "Alexandra Lalor"
output:
  html_document:
    theme: readable
    highlight: 
    toc: yes
    toc_depth: 3
    toc_float:
      smooth_scroll: yes
    code_download: true
  pdf_document:
    toc: yes
    toc_depth: '3'
---

# Before Starting

This code is intended to quality check species metadata, including the Local Species Report. This report can be downloaded via the Species menu on the Species Management tab on the FFI Remote App Server.

### Setup

```{r setup, include=FALSE}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE)
```

```{r install packages, include=FALSE}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("Rtools")
# install.packages("janitor")
# install.packages("condformat")
# install.packages("knitr")
# install.packages("here")
```

```{r load packages, include=FALSE}
## Load Packages

# tidyverse and dplyr have lots of useful functions for data cleaning
library(tidyverse)
library(dplyr)
library(plyr)
# janitor has functions to find duplicates
library(janitor)
# writexl is used to create excel output files
library(writexl)
# condformat is used to format excel output files
library(condformat)
# knitr is used to create output files from R Markdown
library(knitr)
# "here" helps you easily find and reference your working directory
library(here)
```

### Create Function

```{r}
# Blank data frame
errors_blank_meta <- data.frame("SavedQuery" = "", "Macroplot" = "", "Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "")

# QAQC function
qaqc_meta <- function(data, query, query_message, values_check) {
  
  # Check if there is data to QAQC
  if(nrow(data) == 0) {
  # If there is no data, default to "No Error" data frame
  errors <- errors_blank_meta %>%
    mutate(SavedQuery = query,
           Error = "No Error")
  # If there is data, perform error check
} else {
  
  # Use relevant dataset to look for errors
  errors <- data %>%  
    # Add columns relevant to error checking
           # Populate the "SavedQuery" column with the query name
    mutate("SavedQuery" = query, 
           # Populate the "Error" column with the query message and relevant data
           "Error" = paste(query_message, "=", values_data),
           # Create a blank "Fixed" column
           "Fixed" = "",
           # Create a blank "Explanation" column
           "Explanation" = "",
           # Create a blank "Queryers" column
           "Queryers" = "") %>%   
    # Filter for data which is "false" (data does not match valid conditions)
    # NA values are treated as "false" (missing data is not valid)
    filter(!(values_check %>% replace_na(FALSE))) %>%   
    # Select relevant columns to view errors
    select("SavedQuery", "Macroplot", "Error", "Fixed", "Explanation", "Queryers")
  
  # Next, check if there are duplicate errors
  errors_temp <- errors %>% 
    get_dupes(SavedQuery, Macroplot, Error)
  # Merge duplicate errors
  errors <- unique(merge(errors, errors_temp, all = T))
  # If duplicate errors exist, add number of duplicates to error message
  errors <- errors %>% 
    mutate(Error = ifelse(is.na(dupe_count), Error, paste0("(x", dupe_count, ") ", Error))) %>% 
    select(!"dupe_count")
}
  
  # Check if there are no errors
  if (nrow(errors) == 0) {  
    # If there are no errors, default to "No Error" data frame
    errors <- errors_blank_meta %>%
      mutate(SavedQuery = query,
             Error = "No Error")
    # If there are errors, keep error log you just created
  } else {   
    errors <- errors
  }
}
```

### Adjust File Paths

```{r import data, include=FALSE}
# Identify working directory.
here()

# designate target park(s)
target_park <- "GETT"

# Load in data.
path_file <- "C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/Exports/"
path_data <- paste0(path_file, target_park, "/")
path_errors <- paste0(here(), "/output/errors/")
path_errors_name <- paste0(target_park, " Species QAQC Errors")
```

### Load Data

```{r load data, include=FALSE}
## Load Data
SpeciesReport <- read.csv(paste0(path_data, target_park, "_", "SpeciesReport.csv"))
```

### Clean Data

```{r}
SpeciesReport <- SpeciesReport %>%
  # remove trailing/leading whitespace
  mutate(across(where(is.character), str_trim))

# replace commas with semicolons
SpeciesReport[] <- lapply(SpeciesReport, function(x) gsub(",", ";", x))
```

# Park: [`r target_park`]{style="color:red"}

## Species Report

### Sample Events

[Problem:]{.underline} Species Report is missing information related to Local Species columns

[Procedure:]{.underline}

-   Check that LocalSpecies_Symbol is not blank
-   Check that LocalSpecies_GUID is not blank
-   Check that LocalSpecies_Description is not blank
-   Check that LocalSpecies_CommonName is not blank
-   Check that LocalSpecies_LifeCycle is not blank
-   Check that LocalSpecies_UserAdded is not blank
-   Check that LocalSpecies_Nativity is not blank
-   Check that LocalSpecies_Invasive is not blank
-   Check that LocalSpecies_Cultural is not blank
-   Check that LocalSpecies_Concern is not blank
-   Check that LocalSpecies_Retired is not blank
-   Check that LocalSpecies_Comment is not blank
-   Check that LocalSpecies_UV1 is not blank
-   Check that LocalSpecies_UV2 is not blank
-   Check that LocalSpecies_UV3 is not blank
-   Check that LocalSpecies_PreferedLifeForm is not blank

```{r}
# Set parameters 
data <- MacroplotReport_SampleEvents
query <- "Macroplot Report - Sample Events"
query_message <- "Macroplot" 
values_data <- data$Macroplot
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_Macroplot <- qaqc_meta(data, query, query_message, values_check)
```

[Problem:]{.underline} Species Report is missing information related to Master Species columns

[Procedure:]{.underline}

MasterSpecies_ScientificName

-   Check that MasterSpecies_ScientificName is not blank

-   Check that MasterSpecies_ITIS_TSN is not blank

-   Check that MasterSpecies_Genus is not blank

-   Check that MasterSpecies_Family is not blank

-   Check that MasterSpecies_NotBiological is not blank

Combine Species Errors

```{r}
# Combine
errors_Species <- unique(rbind())

remove()

if(nrow(errors_Species) > 1) {
  errors_Species <- errors_Species %>%
    filter(Error != "No Error")
} else {
  errors_Species <- errors_Species}
```

# ALL ERRORS

```{r}
errors_all <- rbind()
```

```{r}
# Create conditional formatting rules
errors_all_cf <- errors_all %>% 
  mutate(Color = ifelse(SavedQuery == "", NA, "Color"))

# Add conditional formating to ouput
errors_all <- condformat(errors_all_cf[1:(nrow(errors_all_cf)), 1:7]) %>%
  rule_fill_discrete(columns = 1:6,
                     expression = (errors_all_cf$Color),
                     colours = c("Color"="#C6E0B4"),
                     na.value = "#FFFFFF") %>%
  select(!c("Color"))
```

```{r}
# Table of results for quick check
kable(errors_all, "pipe")

# Save as CSV or XLSX 
condformat2excel(errors_all, paste0(path_errors, paste0(target_park, "_errors_species.xlsx")), sheet_name = path_errors_name, overwrite_wb = TRUE)
```
