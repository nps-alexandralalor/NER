---
title: "QAQC MetaData"
author: "Alexandra Lalor"
output:
  html_document:
    theme: readable
    highlight: 
    toc: yes
    toc_depth: 1
    toc_float:
      smooth_scroll: yes
    code_download: true
  pdf_document:
    toc: yes
    toc_depth: '3'
---

# Before Starting

This code is intended to quality check plot metadata, including the Macroplot Report, Project Unit Assignment Report, and Sample Event Report. These reports can be downloaded via the Utilities menu on the Project Management tab on the FFI Remote App Server. This code also produces a clean Metadata Report, which combines the Macroplot Report, Project Unit Assignment Report, and Sample Event Report into a single flat file. The Metadata Report is used in subsequent R scripts.

This code is intended to quality check species metadata, including the Local Species Report. This report can be downloaded via the Species menu on the Species Management tab on the FFI Remote App Server.

### Setup {.hidden}

```{r setup, include=FALSE}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE)
```

```{r install packages, include=FALSE}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("Rtools")
# install.packages("janitor")
# install.packages("condformat")
# install.packages("knitr")
# install.packages("here")
```

```{r load packages, include=FALSE}
## Load Packages

# tidyverse and dplyr have lots of useful functions for data cleaning
library(tidyverse)
library(dplyr)
#library(plyr)
# janitor has functions to find duplicates
library(janitor)
# writexl is used to create excel output files
library(writexl)
# condformat is used to format excel output files
library(condformat)
# knitr is used to create output files from R Markdown
library(knitr)
# "here" helps you easily find and reference your working directory
library(here)
```

### Create Function {.hidden}

```{r}
# Create blank data frame as error log template
errors_blank <- data.frame("SavedQuery" = "", "Error" = "", "Fixed" = "", "Explanation" = "", "Queryers" = "")

# Create error group. Duplicate errors will be grouped by these columns.
errors_group <- c("SavedQuery", "Error")

############################################################################################
## Source Code
#Pull in source code that creates QAQC functions and builds an empty error table.
#source("C:/Users/allie/OneDrive/Desktop/R Projects/NER/scripts/1_QAQC/qaqc_function.R")


# QAQC function
qaqc <- function(data, query, query_message, values_check) {

  # Check if there is data to QAQC
  if(nrow(data) == 0) {
  # If there is no data, default to "No Error" data frame
  errors <- errors_blank %>%
    mutate("SavedQuery" = query,
           "Error" = "No Error")
  # If there is data, perform error check
} else {

  # Use relevant dataset to look for errors
  errors <- data %>%
    # Add columns relevant to error checking
           # Populate the "SavedQuery" column with the query name
    mutate("SavedQuery" = query,
           # Populate the "Error" column with the query message and relevant data
           "Error" = paste(query_message, "=", values_data),
           # Create a blank "Fixed" column
           "Fixed" = "",
           # Create a blank "Explanation" column
           "Explanation" = "",
           # Create a blank "Queryers" column
           "Queryers" = "") %>%
    # Filter for data which is "false" (data does not match valid conditions)
    # NA values are treated as "false" (missing data is not valid)
    filter(!(values_check %>% replace_na(FALSE))) %>%
    # Select relevant columns to view errors
    select(colnames(errors_blank))

  # Next, check if there are duplicate errors
  errors_temp <- errors %>%
    get_dupes(errors_group)
  # Merge duplicate errors
  errors <- unique(merge(errors, errors_temp, all = T))
  # If duplicate errors exist, add number of duplicates to error message
  errors <- errors %>%
    mutate(Error = ifelse(is.na(dupe_count), Error, paste0("(x", dupe_count, ") ", Error))) %>%
    select(!"dupe_count")
}

  # Check if there are no errors
  if (nrow(errors) == 0) {
    # If there are no errors, default to "No Error" data frame
    errors <- errors_blank %>%
      mutate(SavedQuery = query,
             Error = "No Error")
    # If there are errors, keep error log you just created
  } else {
    errors <- errors
  }
}
```

### Target Park {.hidden}

```{r}
# designate target park(s)
target_park <- "SHEN"
```

### Adjust File Paths {.hidden}

```{r import data, include=FALSE}
# adjust file paths
#path_main <- "E:/Allie/FireFX_NER/FFI Data Management/"
path_main <- "C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/"
path_data <- paste0(path_main, "Exports/", target_park, "/", target_park, "_")
path_save <- paste0(path_main, "R Outputs/", target_park, "/")
path_errors <- paste0(path_main, "QAQC/", target_park, "/")
path_errors_name <- paste0(target_park, " Metadata QAQC Errors")
```

### Load Data {.hidden}

```{r load data, include=FALSE}
## Load Data, replace blanks and text NA as actual NA
MacroplotReport <- read.csv(paste0(path_data, "MacroplotReport.csv"))
ProjectUnitReport <- read.csv(paste0(path_data, "ProjectUnitAssignmentReport.csv"))
SampleEventReport <- read.csv(paste0(path_data, "SampleEventReport.csv"))
SpeciesReport <- read.csv(paste0(path_data, "LocalSpeciesReport.csv"))
```

# Park: [`r target_park`]{style="color:red"}

# Macroplot Report

[Problem:]{.underline} Macroplot Report include symbols or discrepencies which will cause issues later on.

[Procedure:]{.underline}

-   Check that Quotes = FALSE

```{r}
# Set parameters 
data <- MacroplotReport %>% 
  mutate(Quotes = pmap_lgl(as.list(MacroplotReport), 
    ~ any(str_detect(c(...), '["]')))) %>% 
  mutate(Quotes = ifelse(is.na(Quotes), FALSE, Quotes))
query <- "Macroplot Report"
query_message <- "Quotes"
values_data <- data$Quotes
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_MacroplotReport_Quotes <- qaqc(data, query, query_message, values_check)
```

-   Check that Commas = FALSE

```{r}
# Set parameters 
data <- MacroplotReport %>% 
  mutate(Commas = pmap_lgl(as.list(MacroplotReport), 
    ~ any(str_detect(c(...), '[,]')))) %>% 
  mutate(Commas = ifelse(is.na(Commas), FALSE, Commas))
query <- "Macroplot Report"
query_message <- "Commas"
values_data <- data$Commas
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_MacroplotReport_Commas <- qaqc(data, query, query_message, values_check)
```

-   Check that columns match expected

```{r}
# Set parameters 
data <- MacroplotReport
values_data <- names(data)
values_valid <- c("Macroplot", "SampleEventDate", "SampleEventTeam", "SampleEventComment", "MonStatusOrd", "MonStatus", "LegacyMonStatus", "Purpose", "LocatedBy", "Type", "Latitude", "Longitude", "UTM_X", "UTM_Y", "UTM_Zone", "Datum", "PDOP", "Precision", "DateIn", "FutureVisit", "DateOut", "Elevation", "ElevationUnits", "Azimuth", "Aspect", "SlopeHill", "SlopeTransect", "StartPoint", "Directions", "Comments", "MetaData", "UV1", "UV2", "UV3", "UV4", "UV5", "UV6", "UV7", "UV8")
MissingColumn <- setdiff(values_data, values_valid)
if(length(MissingColumn) == 0) {
  MissingColumn <- "none"
} else {
  MissingColumn <- paste((MissingColumn), collapse = ", ")
}

data$MissingColumn <- MissingColumn
query <- "Macroplot Report"
query_message <- "Missing/Extra Columns"
values_data <- data$MissingColumn
values_valid <- "none"
values_check <- values_data == values_valid

# Identify errors
errors_MacroplotReport_Columns <- qaqc(data, query, query_message, values_check)
```

-   Check that Macroplot is not blank

```{r}
# Set parameters 
data <- MacroplotReport
query <- "Macroplot Report"
query_message <- "Macroplot" 
values_data <- data$Macroplot
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_MacroplotReport_Macroplot <- qaqc(data, query, query_message, values_check)
```

### Combine Macroplot Report Errors

```{r}
errors_MacroplotReport <- rbind(errors_MacroplotReport_Quotes, errors_MacroplotReport_Commas, errors_MacroplotReport_Columns, errors_MacroplotReport_Macroplot)

remove(errors_MacroplotReport_Quotes, errors_MacroplotReport_Commas, errors_MacroplotReport_Columns, errors_MacroplotReport_Macroplot)

if(nrow(errors_MacroplotReport) > 1) {
  errors_MacroplotReport <- errors_MacroplotReport %>%
    filter(Error != "No Error")
} else {
  errors_MacroplotReport <- errors_MacroplotReport}
```

# Project Unit Assignment Report

[Problem:]{.underline} Project Unit Assignment Report is missing information.

[Procedure:]{.underline}

-   Check that Quotes = FALSE

```{r}
# Set parameters 
data <- ProjectUnitReport %>% 
  mutate(Quotes = pmap_lgl(as.list(ProjectUnitReport), 
    ~ any(str_detect(c(...), '["]')))) %>% 
  mutate(Quotes = ifelse(is.na(Quotes), FALSE, Quotes))
query <- "Project Unit Report"
query_message <- "Quotes"
values_data <- data$Quotes
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_ProjectUnitReport_Quotes <- qaqc(data, query, query_message, values_check)
```

-   Check that Commas = FALSE

```{r}
# Set parameters 
data <- ProjectUnitReport %>% 
  mutate(Commas = pmap_lgl(as.list(ProjectUnitReport), 
    ~ any(str_detect(c(...), '[,]')))) %>% 
  mutate(Commas = ifelse(is.na(Commas), FALSE, Commas))
query <- "Project Unit Report"
query_message <- "Commas"
values_data <- data$Commas
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_ProjectUnitReport_Commas <- qaqc(data, query, query_message, values_check)
```

-   Check that columns match expected

```{r}
# Set parameters 
data <- ProjectUnitReport
values_data <- names(data)
values_valid <- c("Macroplot", "ProjectUnit", "Multi_PU")
MissingColumn <- setdiff(values_data, values_valid)
if(length(MissingColumn) == 0) {
  MissingColumn <- "none"
} else {
  MissingColumn <- paste((MissingColumn), collapse = ", ")
}

data$MissingColumn <- MissingColumn
query <- "Project Unit Report"
query_message <- "Missing/Extra Columns"
values_data <- data$MissingColumn
values_valid <- "none"
values_check <- values_data == values_valid

# Identify errors
errors_ProjectUnitReport_Columns <- qaqc(data, query, query_message, values_check)
```

-   Check that Macroplot is not blank

```{r}
# Set parameters 
data <- ProjectUnitReport
query <- "Project Unit Report"
query_message <- "Macroplot" 
values_data <- data$Macroplot
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_ProjectUnitReport_Macroplot <- qaqc(data, query, query_message, values_check)
```

-   Check that ProjectUnit is not blank

```{r}
# Set parameters 
data <- ProjectUnitReport
query <- "Project Unit Report"
query_message <- "Project Unit" 
values_data <- data$ProjectUnit
values_valid <- ""
values_check <- values_data != values_valid

# Identify errors
errors_ProjectUnitReport_ProjectUnit <- qaqc(data, query, query_message, values_check)
```

-   Check that Multi_PU = N or Y. If Multi_PU = Y, you will need to isolate which Project Unit contains the primary data for the analysis of interest.

```{r}
# Set parameters 
data <- ProjectUnitReport
query <- "Project Unit Report"
query_message <- "Multi Project Units" 
values_data <- data$Multi_PU
values_valid <- c("N")
values_check <- values_data %in% values_valid

# Identify errors
errors_ProjectUnitReport_MultiPU <- qaqc(data, query, query_message, values_check)
```

### Combine Project Unit Report Errors

```{r}
errors_ProjectUnitReport <- unique(rbind(errors_ProjectUnitReport_Quotes, errors_ProjectUnitReport_Commas, errors_ProjectUnitReport_Columns, errors_ProjectUnitReport_Macroplot, errors_ProjectUnitReport_ProjectUnit, errors_ProjectUnitReport_MultiPU))

remove(errors_ProjectUnitReport_Quotes, errors_ProjectUnitReport_Commas, errors_ProjectUnitReport_Columns, errors_ProjectUnitReport_Macroplot, errors_ProjectUnitReport_ProjectUnit, errors_ProjectUnitReport_MultiPU)

if(nrow(errors_ProjectUnitReport) > 1) {
  errors_ProjectUnitReport <- errors_ProjectUnitReport %>%
    filter(Error != "No Error")
} else {
  errors_ProjectUnitReport <- errors_ProjectUnitReport}
```

# Sample Event Report

[Problem:]{.underline} Sample Event Report is missing information or is inconsistent with the Macroplot Report

[Procedure:]{.underline}

-   Check that Quotes = FALSE

```{r}
# Set parameters 
data <- SampleEventReport %>% 
  mutate(Quotes = pmap_lgl(as.list(SampleEventReport), 
    ~ any(str_detect(c(...), '["]')))) %>% 
  mutate(Quotes = ifelse(is.na(Quotes), FALSE, Quotes))
query <- "Sample Event Report"
query_message <- "Quotes"
values_data <- data$Quotes
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_Quotes <- qaqc(data, query, query_message, values_check)
```

-   Check that Commas = FALSE

```{r}
# Set parameters 
data <- SampleEventReport %>% 
  mutate(Commas = pmap_lgl(as.list(SampleEventReport), 
    ~ any(str_detect(c(...), '[,]')))) %>% 
  mutate(Commas = ifelse(is.na(Commas), FALSE, Commas))
query <- "Sample Event Report"
query_message <- "Commas"
values_data <- data$Commas
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_Commas <- qaqc(data, query, query_message, values_check)
```

-   Check that columns match expected

```{r}
# Set parameters 
data <- SampleEventReport
values_data <- names(data)
values_valid <- c("AdministrationUnit_Name", "ProjectUnit_Name", "MacroPlot_Name", "Multi_PU", "SampleEvent_Date", "SampleEvent_LegacyMonitoringStatus", "MonitoringStatus_Name", "Protocols", "Visited")
MissingColumn <- setdiff(values_data, values_valid)
if(length(MissingColumn) == 0) {
  MissingColumn <- "none"
} else {
  MissingColumn <- paste((MissingColumn), collapse = ", ")
}

data$MissingColumn <- MissingColumn
query <- "Sample Event Report"
query_message <- "Missing/Extra Columns"
values_data <- data$MissingColumn
values_valid <- "none"
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_Columns <- qaqc(data, query, query_message, values_check)
```

-   Compare unique MonStatus between both the Sample Event Report and Metadata Report. Isolate differences between reports.

```{r}
# Compare MonStatus between Sample Event Report and Metadata Report, isolate differences
data_temp1 <- SampleEventReport %>%
  dplyr::rename(Macroplot = MacroPlot_Name,
                SampleEventDate = SampleEvent_Date,
                MonStatus = MonitoringStatus_Name) %>% 
  select(Macroplot, SampleEventDate, MonStatus) %>% 
  unique()

data_temp2 <- MacroplotReport %>% 
  select(Macroplot, SampleEventDate, MonStatus) %>% 
  filter(!is.na(SampleEventDate)) %>% 
  unique()

data_temp <- setdiff(data_temp1, data_temp2) %>% 
  mutate(MonStatusError = MonStatus) %>% 
  filter(MonStatus != "") %>% 
  select(!MonStatus)
remove(data_temp1, data_temp2)

# Set parameters 
data <- merge(MacroplotReport, data_temp, by = c("Macroplot", "SampleEventDate"), all = T)
data$MonStatusError[is.na(data$MonStatusError)] <- ""

data <- data %>% 
  filter(MonStatusError != "")
query <- "Sample Event Report"
query_message <- paste0("MacroplotReport MonStatus = ", data$MonStatus, ". ", "SampleEventReport MonStatus") 
values_data <- data$MonStatusError
values_valid <- data$MonStatus
values_check <- values_data == values_valid

# Identify errors
errors_SampleEventReport_MonStatus <- qaqc(data, query, query_message, values_check)
```

### Combine Sample Event Report Errors

```{r}
errors_SampleEventReport <- unique(rbind(errors_SampleEventReport_Quotes, errors_SampleEventReport_Commas, errors_SampleEventReport_Columns, errors_SampleEventReport_MonStatus))

remove(errors_SampleEventReport_Quotes, errors_SampleEventReport_Commas, errors_SampleEventReport_Columns, errors_SampleEventReport_MonStatus)

if(nrow(errors_SampleEventReport) > 1) {
  errors_SampleEventReport <- errors_SampleEventReport %>%
    filter(Error != "No Error")
} else {
  errors_SampleEventReport <- errors_SampleEventReport}
```

# Species Report

[Problem:]{.underline} Species Report includes symbols which will cause issues later on.

[Procedure:]{.underline}

-   Check that Quotes = FALSE

```{r}
# Set parameters 
data <- SpeciesReport %>% 
  mutate(Quotes = pmap_lgl(as.list(SpeciesReport), 
    ~ any(str_detect(c(...), '["]')))) %>% 
  mutate(Quotes = ifelse(is.na(Quotes), FALSE, Quotes))
query <- "Species Report"
query_message <- "Quotes"
values_data <- data$Quotes
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_SpeciesReport_Quotes <- qaqc(data, query, query_message, values_check)
```

-   Check that Commas = FALSE

```{r}
# Set parameters 
data <- SpeciesReport %>% 
  mutate(Commas = pmap_lgl(as.list(SpeciesReport), 
    ~ any(str_detect(c(...), '[,]')))) %>% 
  mutate(Commas = ifelse(is.na(Commas), FALSE, Commas))
query <- "Species Report"
query_message <- "Commas"
values_data <- data$Commas
values_valid <- FALSE
values_check <- values_data == values_valid

# Identify errors
errors_SpeciesReport_Commas <- qaqc(data, query, query_message, values_check)
```

-   Check that columns match expected

```{r}
# Set parameters 
data <- SpeciesReport
values_data <- names(data)
values_valid <- c("LocalSpecies_Symbol", "LocalSpecies_GUID", "LocalSpecies_Description", "LocalSpecies_CommonName", "LocalSpecies_LifeCycle", "LocalSpecies_UserAdded", "LocalSpecies_Nativity", "LocalSpecies_Invasive", "LocalSpecies_Cultural", "LocalSpecies_Concern", "LocalSpecies_Retired", "LocalSpecies_Comment", "LocalSpecies_UV1", "LocalSpecies_UV2", "LocalSpecies_UV3", "LocalSpecies_PreferedLifeForm", "MasterSpecies_ScientificName", "MasterSpecies_ITIS_TSN", "MasterSpecies_Genus", "MasterSpecies_Family", "MasterSpecies_NotBiolgoical", "ReportType")
MissingColumn <- setdiff(values_data, values_valid)
if(length(MissingColumn) == 0) {
  MissingColumn <- "none"
} else {
  MissingColumn <- paste((MissingColumn), collapse = ", ")
}

data$MissingColumn <- MissingColumn
query <- "Species Report"
query_message <- "Missing/Extra Columns"
values_data <- data$MissingColumn
values_valid <- "none"
values_check <- values_data == values_valid

# Identify errors
errors_SpeciesReport_Columns <- qaqc(data, query, query_message, values_check)
```

### Combine Species Report Errors

```{r}
errors_SpeciesReport <- rbind(errors_SpeciesReport_Quotes, errors_SpeciesReport_Commas, errors_SpeciesReport_Columns)

remove(errors_SpeciesReport_Quotes, errors_SpeciesReport_Commas, errors_SpeciesReport_Columns)

if(nrow(errors_SpeciesReport) > 1) {
  errors_SpeciesReport <- errors_SpeciesReport %>%
    filter(Error != "No Error")
} else {
  errors_SpeciesReport <- errors_SpeciesReport}
```

# ALL ERRORS

```{r}
errors_all <- rbind(errors_MacroplotReport, errors_blank, errors_ProjectUnitReport, errors_blank, errors_SampleEventReport, errors_blank, errors_SpeciesReport)
```

```{r}
# Create conditional formatting rules
errors_all_cf <- errors_all %>% 
  mutate(Color = ifelse(SavedQuery == "", NA, "Color"))

# Add conditional formating to ouput
errors_all <- condformat(errors_all_cf[1:(nrow(errors_all_cf)), 1:7]) %>%
  rule_fill_discrete(columns = 1:6,
                     expression = (errors_all_cf$Color),
                     colours = c("Color"="#C6E0B4"),
                     na.value = "#FFFFFF") %>%
  select(!c("Color"))
```

```{r}
# Table of results for quick check
kable(errors_all, "pipe")

# Save as CSV or XLSX 
#condformat2excel(errors_all, paste0(path_errors, paste0(target_park, "_errors_CSVsComplete.xlsx")), sheet_name = path_errors_name, overwrite_wb = TRUE)
```
