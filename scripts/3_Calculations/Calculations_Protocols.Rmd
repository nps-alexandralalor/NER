---
title: "FFI Database Summary"
subtitle: Northeast Region
output:
  word_document:
    toc: true
    toc_depth: 2
  pdf_document:
    toc: true
    toc_depth: 2
  html_document:
    theme: readable
    highlight: null
    toc: true
    toc_depth: 2
    toc_float:
      smooth_scroll: true
    code_download: true
---

# BEFORE STARTING

### Setup {.hidden}

```{r}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE)
```

```{r}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("kableExtra")
# install.packages("ggplot2")
```

```{r}
## Load Packages

# "tidyverse" has lots of useful functions for data cleaning
library(tidyverse)
# "kableExtra" is used to produce formatted tables
library(kableExtra)
library(ggplot2)
library(stringr)
library(DT)
library(fs)
```

### Target Park

```{r}
# target_park <- c("RICH")
# target_project <- c("Big Meadows West")
# target_type <- c("Forest")
# target_years <- c(2025)
```

### Adjust File Paths

```{r}
## Adjust File Paths
#path_file <- "E:/Allie/FireFX_NER/FFI Data Management/R Outputs/"
path_file <- "C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/R Outputs/"
path_data <- paste0(path_file, "ALL/ALL_")
path_save <- paste0(path_file, "ALL/Calculations/ALL_")
```

### Load Data {.hidden}

```{r}
# Load in data
Fuels1000 <- read.csv(paste0(path_data, "Data_Surface Fuels - 1000Hr.csv"))
FuelsDuffLitt <- read.csv(paste0(path_data, "Data_Surface Fuels - Duff_Litter.csv"))
FuelsFine <- read.csv(paste0(path_data, "Data_Surface Fuels - Fine.csv"))

# Trees <- read.csv(paste0(path_data, "Data_Trees - Individuals (metric).csv"))
Seedlings <- read.csv(paste0(path_data, "Data_Density - Quadrats (metric).csv"))

HerbsSpComp <- read.csv(paste0(path_data, "Data_Cover - Species Composition (metric).csv"))
HerbsPoints <- read.csv(paste0(path_data, "Data_Cover - Points (metric).csv"))

# PostBurn <- read.csv(paste0(path_data, "Data_Post Burn Severity (metric).csv"))
# Shrubs <- read.csv(paste0(path_data, "Data_Density - Belts (metric).csv"))
```

# Surface Fuels

## Fuels 1000

```{r calculate fuel loads, include=FALSE}
# -------------------------- #
# ---- 1,000-Hour Fuels ---- #
# -------------------------- #

# ---- Function to calculate 1000-hr fuels for any park dataset ---- #
calculate_coarse_fuels <- function(fuels_df) {


  # ---- Step 1: Ensure Transect is numeric BEFORE calculations ---- #
  fuels_df <- Fuels1000_all %>% 
    mutate(
      SampleEventDate = ymd(SampleEventDate),
      Transect = suppressWarnings(as.numeric(Transect)),
      DecayCl = suppressWarnings(as.numeric(DecayCl)),
      Dia = suppressWarnings(as.numeric(Dia))
      )
  
  # ---- Step 2: Compute per-log contributions ---- #
  #a <- 1.0
  #s_sound <- 0.4
  #s_rotten <- 0.3
  #conversion_factor <- 11.64

  fuels_processed <- fuels_df %>%
    filter(DecayCl %in% c(3, 4)) %>%
    mutate(
      a = 1.0,
      s_sound = 0.4,
      s_rotten = 0.3,
      conversion_factor = 11.64,
      D2 = Dia^2,
      s = if_else(DecayCl == 3, s_sound, s_rotten),
      slope_correction = sqrt(1 + (Slope / 100)^2),
      Load = (conversion_factor * D2 * s * a * slope_correction) / TranLen,
      Load_Adjusted = Load / NumTran
    )

  # ---- Step 3A: Summarise computed loads (only where logs existed) ---- #
  loads_per_transect <- fuels_processed %>% 
   group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate, Transect) %>% 
    dplyr::summarise(
      ThousHrTranLen           = TranLen,
      ThousHrSound             = sum((DecayCl == 3), na.rm = TRUE),
      ThousHrRott              = sum((DecayCl == 4), na.rm = TRUE),
      ThousHr                  = sum((DecayCl %in% c(3,4)), na.rm = TRUE),
      ThousHrSound_FuelLoad    = sum(Load[DecayCl == 3], na.rm = TRUE),
      ThousHrRott_FuelLoad     = sum(Load[DecayCl == 4], na.rm = TRUE),
      ThousHr_FuelLoad         = sum(Load, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    mutate(Transect = suppressWarnings(as.numeric(Transect)))
  
  
  # ---- Step 3B: Create full grid of expected transects per plot/year ---- #
  all_transects <- fuels_df %>%
    select(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate, NumTran, Transect, TranLen) %>% 
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate) %>%
    tidyr::uncount(weights = NumTran, .id = "Transect") %>%
    mutate(Transect = suppressWarnings(as.numeric(Transect))) %>% 
    dplyr::rename(ThousHrTranLen = TranLen) %>% 
    unique()
  
  
  # ---- Step 5C: Bring zeros back in for missing decay classes ---- #
  fuel_by_transect <- all_transects %>%
    left_join(loads_per_transect,
              by = c("AdministrationUnit_Name", "SampleEvent_TreatmentUnit", "Macroplot", "SampleEventDate", "Transect", "ThousHrTranLen")) %>%
    mutate(
      #ThousHrTranLen      = replace_na(ThousHrTranLen),
      ThousHrSound        = replace_na(ThousHrSound, 0),
      ThousHrRott         = replace_na(ThousHrRott, 0),
      ThousHr             = replace_na(ThousHr, 0),
      ThousHrSound_FuelLoad     = replace_na(ThousHrSound_FuelLoad, 0),
      ThousHrRott_FuelLoad     = replace_na(ThousHrRott_FuelLoad, 0),
      ThousHr_FuelLoad = replace_na(ThousHr_FuelLoad, 0)
    ) %>% 
    unique


  return(fuel_by_transect)
}
```

## Fuels Duff Litter

```{r calculate fuel loads, include=FALSE}
# -------------------------------------- #  
# ---- Litter and Duff Measurements ---- #
# -------------------------------------- #

# ---- Function to calculate litter and duff fuel loads ---- #
calculate_litterduff <- function(fuels_df) {
 
  
  # ---- Step 1: Ensure Transect is numeric BEFORE calculations ---- #
  
  fuels_df <- fuels_df %>% 
    mutate(
      SampleEventDate = ymd(SampleEventDate),
      Transect = suppressWarnings(as.numeric(Transect))
      )
  
  # ================================ #
  # ==== Bulk density constants ==== #
  # ================================ #

  #litter_bd <- 2.75 * 1.815 # FFI default bulk density for litter (2.75)
  #duff_bd   <- 5.5  * 1.815 # FFI default bulk density for duff (5.5)
  
  # ---- Step 2: Transect-level averages ---- #
  transect_means <- fuels_df %>%
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate, Transect, NumTran) %>% 
    dplyr::summarise(
      Tran_LittDep = mean(LittDep, na.rm = TRUE),
      Tran_DuffDep = mean(DuffDep, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    filter(Transect <= NumTran) %>%   # keep only valid transects
    mutate(
      litter_bd = 2.75 * 1.815, # FFI default bulk density for litter (2.75)
      duff_bd   = 5.5  * 1.815, # FFI default bulk density for duff (5.5)
      Tran_Litt_FuelLoad = Tran_LittDep * litter_bd,
      Tran_Duff_FuelLoad   = Tran_DuffDep * duff_bd,
      Tran_LittDuff_FuelLoad  = Tran_Litt_FuelLoad + Tran_Duff_FuelLoad
    )
  
  # ---- Step 3: Plot-level averages ---- #
  plot_means <- transect_means %>%
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate) %>%
    dplyr::summarise(
      Transect = Transect,
      
      # ---- KEEP TRANSECT FUEL VALUES ---- #
      Tran_LittDep = Tran_LittDep,
      Tran_DuffDep = Tran_DuffDep,
      Tran_Litt_FuelLoad = Tran_Litt_FuelLoad,
      Tran_Duff_FuelLoad   = Tran_Duff_FuelLoad,
      Tran_LittDuff_FuelLoad  = Tran_LittDuff_FuelLoad,
      
      # ---- plot-level depth ---- #
      Avg_LittDep = mean(Tran_LittDep, na.rm = TRUE),
      Avg_DuffDep = mean(Tran_DuffDep, na.rm = TRUE),
  
      # ---- plot-level fuels ---- #
      Avg_Litt_FuelLoad = mean(Tran_Litt_FuelLoad, na.rm = TRUE),
      Avg_Duff_FuelLoad   = mean(Tran_Duff_FuelLoad, na.rm = TRUE),
      Avg_LittDuff_FuelLoad  = mean(Tran_LittDuff_FuelLoad, na.rm = TRUE),
  
      .groups = "drop"
  )
  
  return(plot_means)
}
```

## Fuels Fine

```{r calculate fuel loads, include=FALSE}
# ------------------------------------- #
# ---- Fine Fuels (1,10,100-Hours) ---- #
# ------------------------------------- #

# ---- Function to calculate 1-100-hr fuels for any park dataset ---- #
calculate_fine_fuels <- function(fuels_df) {
  
  # ---- Step 1: Ensure Date is proper datetime format ---- #
  fuels_df <- fuels_df %>%
    mutate(
      SampleEventDate = ymd(SampleEventDate)
    )
  
  # ---- Step 2: Compute per-transect fuel load ---- #
  transect_level <- fuels_df %>%
    mutate(
      d2_1hr = 0.0151,
      d2_10hr = 0.289, 
      d2_100hr = 2.76, 
      s_1hr_10hr = 0.48,
      s_100hr = 0.40,
      a = 1.13,
      c = sqrt(1 + (Slope / 100)^2),
      OneHr_FuelLoad = (11.64 * OneHr * d2_1hr   * s_1hr_10hr * a * c) / OneHrTranLen,
      TenHr_FuelLoad = (11.64 * TenHr * d2_10hr  * s_1hr_10hr * a * c) / TenHrTranLen,
      HunHr_FuelLoad = (11.64 * HunHr * d2_100hr * s_100hr    * a * c) / HunHrTranLen,
      Fine_FuelLoad = OneHr_FuelLoad + TenHr_FuelLoad + HunHr_FuelLoad
    )

  # ---- Step 3: KEEP TRANSECT-LEVEL DATA (do NOT summarise here) ---- #
  plot_level_fine <- transect_level %>%
    dplyr::mutate(
      Transect_ID = row_number()  # keeps unique transect within plot
    )
}
```

## Combine Fuels

```{r calculate fuel loads, include=FALSE}
Fuels1000_all <- Fuels1000 %>% 
  select(!c(Purpose, Type, MacroPlot.UV1, MacroPlot.UV2, MacroPlot.UV3, MacroPlot.UV4, MacroPlot.UV5, MacroPlot.UV6, MacroPlot.UV7, MacroPlot.UV8, MonStatus, Status.Prefix, Status.Base, Status.Suffix, MonStatusOrd, SampleEventDate_Year, FieldTeam, EntryTeam, UV1Desc, UV2Desc, UV2Desc, UV3Desc, SaComment, Visited, Index)) %>% 
  mutate(SampleEventDate = ymd(SampleEventDate))

Fuels1000_sum <- calculate_coarse_fuels(Fuels1000_all)
FuelsDuffLitt_sum <- calculate_litterduff(FuelsDuffLitt)
FuelsFine_sum <- calculate_fine_fuels(FuelsFine)
```

```{r combine dataframes, include=FALSE}
# ============================================================= #
# ==== Join 1-100-hr, litter-duff, and 1,000-hr dataframes ==== #
# ============================================================= #

Fuels <- FuelsFine_sum %>%
  full_join(FuelsDuffLitt_sum, by = c("AdministrationUnit_Name", "SampleEvent_TreatmentUnit", "Macroplot", "SampleEventDate", "Transect")) %>% 
  left_join(Fuels1000_sum, by = c("AdministrationUnit_Name", "SampleEvent_TreatmentUnit", "Macroplot", "SampleEventDate", "Transect")) %>% 
  relocate(ThousHrTranLen, .after = HunHrTranLen) %>% 
  relocate(ThousHrSound, .after = HunHr) %>% 
  relocate(ThousHrRott, .after = ThousHrSound) %>% 
  relocate(ThousHr, .after = ThousHrRott) %>% 
  mutate(
    Avg_Litt_FuelLoad = na_if(Avg_Litt_FuelLoad, NaN),
    Avg_Duff_FuelLoad = na_if(Avg_Duff_FuelLoad, NaN),
    across(
      c(ThousHrSound_FuelLoad, ThousHrRott_FuelLoad, ThousHr_FuelLoad),
      ~ replace_na(., 0)
))
```

```{r}
write.csv(Fuels, paste0(path_save, "Data_Surface Fuels.csv"), quote = FALSE, row.names = FALSE)
```

# Trees

# Seedlings

```{r}
# ------------------------------------- #
# ----           Seedlings         ---- #
# ------------------------------------- #
#seedlings_df <- Seedlings
# ---- Function to calculate 1-100-hr fuels for any park dataset ---- #
calculate_seedlings_dens <- function(seedlings_df) {
  
  # ---- Step 1: Ensure Date is proper datetime format ---- #
  seedlings_df <- seedlings_df %>%
    mutate(
      SampleEventDate = ymd(SampleEventDate)
    )
  
  # ---- Step 2: Compute per-transect fuel load ---- #
  plot_level <- seedlings_df %>%
    mutate(
      SizeCl = if_else(Height <= 4, "< 1m", "> 1m"),
      Area = QuadLen * QuadWid,
      Hectar = Area / 10000,
      Acre = Hectar * 2.47105,
      SizeClGenus_SeedDens_ha = round(Count / Hectar),
      SizeClGenus_SeedDens_ac = round(Count / Acre)
    ) %>% 
    relocate(Count, .after = Acre) %>% 
    relocate(Genus, .after = Acre) %>% 
    relocate(SizeCl, .after = Acre)

  # ---- Step 3: Plot-level summaries ---- #
  plot_level_SizeCl <- plot_level %>%
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate, SizeCl) %>% 
    summarise(SizeCl_Count = sum(Count),
              SizeCl_SeedDens_ha = round(SizeCl_Count / Hectar),
              SizeCl_SeedDens_ac = round(SizeCl_Count / Acre),
              .groups = "drop") %>% 
    unique()
  
  
  plot_level_Genus <- plot_level %>%
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate, Genus) %>% 
    summarise(Genus_Count = sum(Count),
              Genus_SeedDens_ha = round(Genus_Count / Hectar),
              Genus_SeedDens_ac = round(Genus_Count / Acre),
              .groups = "drop") %>% 
    unique()
  
  plot_level_Total <- plot_level %>% 
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, SampleEventDate) %>% 
    summarise(Total_Count = sum(Count),
              Total_SeedDens_ha = round(Total_Count / Hectar),
              Total_SeedDens_ac = round(Total_Count / Acre),
              .groups = "drop") %>% 
    unique()
    
  # ---- Step 4: COMBINE ---- #
  plot_level_merge <- plot_level %>% 
    full_join(plot_level_Total, by = c("AdministrationUnit_Name", "SampleEvent_TreatmentUnit", "Macroplot", "SampleEventDate")) %>% 
    full_join(plot_level_SizeCl, by = c("AdministrationUnit_Name", "SampleEvent_TreatmentUnit", "Macroplot", "SampleEventDate", "SizeCl")) %>% 
    full_join(plot_level_Genus, by = c("AdministrationUnit_Name", "SampleEvent_TreatmentUnit", "Macroplot", "SampleEventDate", "Genus"))
  
}

# trees <- c(
#   "Acer", "Ailanthus", "Albizia", "Amelanchier", "Aralia", "Asimina", 
#   "Betula", "Carpinus", "Carya", "Castanea", "Catalpa", "Celtis", 
#   "Cercis", "Cornus", "Crataegus", "Diospyros", "Fagus", "Fraxinus", 
#   "Gleditsia", "Hamamelis", "Juglans", "Juniperus", "Kalmia", "Ligustrum", 
#   "Liquidambar", "Liriodendron", "Magnolia", "Malus", "Morella", "Morus", 
#   "Nyssa", "Ostrya", "Oxydendrum", "Paulownia", "Pinus", "Platanus", 
#   "Populus", "Prunus", "Pyrus", "Quercus", "Rhus", "Robinia", "Salix", 
#   "Sassafras", "Staphylea", "Taxus", "Tilia", "Tsuga", "Ulmus", "Viburnum"
# )
```

```{r}
Seedlings_sum <- calculate_seedlings_dens(Seedlings)
```

```{r}
write.csv(Seedlings_sum, paste0(path_save, "Data_Density - Quadrats (metric).csv"), quote = FALSE, row.names = FALSE)
```

# Herbs Species Comp

```{r}
# HerbsSpComp_all <- merge(HerbsSpComp, MetadataReport_merge, by = c("AdministrationUnit_Name", "Purpose", "Type", "Macroplot", "MacroPlot.UV1", "MacroPlot.UV2", "MacroPlot.UV3", "MacroPlot.UV4", "MacroPlot.UV5", "MacroPlot.UV6", "MacroPlot.UV7", "MacroPlot.UV8", "MonStatus", "SampleEventDate", "SampleEventDate_Year"), all.x = T) %>% 
#   # Reorganize Columns
#   relocate(Region, .before = AdministrationUnit_Name) %>% 
#   relocate(Zone, .before = AdministrationUnit_Name) %>%
#   relocate(Unit, .before = AdministrationUnit_Name) %>% 
#   relocate(Purpose_Code, .after = Purpose) %>% 
#   relocate(Plot_Type, .after = Type) %>% 
#   relocate(Macroplot_Num, .after = Macroplot) %>% 
#   relocate(Macroplot_Code, .after = Macroplot) %>% 
#   # Protocol Specific Columns
#   mutate(Nativity = ifelse(Native.Species == "True", "Native",
#                            ifelse(Invasive.Species == "True", "Invasive", "Unknown"))) 
```

```{r}
# ------------------------------------- #
# ---- Cover Species Composition   ---- #
# ------------------------------------- #
#cover_df <- HerbsSpComp
# ---- Function to calculate 1-100-hr fuels for any park dataset ---- #
calculate_SpComp_cover <- function(cover_df) {
  
  # ---- Step 1: Ensure Date is proper datetime format ---- #
  cover_df <- cover_df %>%
    mutate(
      SampleEventDate = ymd(SampleEventDate)
    )
  
  # ---- Step 3: KEEP TRANSECT-LEVEL DATA (do NOT summarise here) ---- #
  plot_level <- cover_df %>%
    mutate(
      Nativity = ifelse(Native.Species == "True", "Native",
                           ifelse(Invasive.Species == "True", "Invasive", "Unknown"))
      ) %>% 
    # ---- KEEP PLOT-LEVEL DATA (do NOT summarise here) ---- #
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, MonStatus, SampleEventDate_Year) %>%
    dplyr::mutate(
      n_species_ByPlot = n_distinct(Species.Symbol)) %>% 
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, MonStatus, SampleEventDate_Year, Nativity) %>%
    dplyr::mutate(
      n_species_ByPlotNativity = n_distinct(Species.Symbol)) %>%
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, MonStatus, SampleEventDate_Year, Preferred_Lifeform) %>%
    dplyr::mutate(
      n_species_ByPlotLifeform = n_distinct(Species.Symbol)) %>%
    # ---- KEEP BURN UNIT-LEVEL DATA (do NOT summarise here) ---- #
    group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, MonStatus, SampleEventDate_Year, Nativity) %>%
    dplyr::mutate(
      n_species_ByNativity = n_distinct(Species.Symbol)) %>% 
      group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, MonStatus, SampleEventDate_Year, Nativity) %>%
    dplyr::mutate(
      n_species_ByLifeform = n_distinct(Species.Symbol)) %>% 
    # ---- KEEP BURN UNIT-LEVEL DATA (do NOT summarise here) ---- #
    ungroup()
}
```

```{r}
HerbsSpComp_sum <- calculate_SpComp_cover(HerbsSpComp)
```

```{r}
write.csv(HerbsSpComp_sum, paste0(path_save, "Data_Cover - Species Composition (metric).csv"), quote = FALSE, row.names = FALSE)
```

# Herbs Points

```{r}
# ------------------------------------- #
# ---- Cover Points                ---- #
# ------------------------------------- #
# cover_df <- HerbsPoints
# # ---- Function to calculate 1-100-hr fuels for any park dataset ---- #
# calculate_Points_cover <- function(cover_df) {
#   
#   # ---- Step 1: Ensure Date is proper datetime format ---- #
#   cover_df <- cover_df %>%
#     mutate(
#       SampleEventDate = ymd(SampleEventDate)
#     )
#   
#   # ---- Step 3: KEEP TRANSECT-LEVEL DATA (do NOT summarise here) ---- #
#   plot_level <- cover_df %>%
#     mutate(
#       Nativity = ifelse(Native.Species == "True", "Native",
#                            ifelse(Invasive.Species == "True", "Invasive", "Unknown"))
#       ) %>% 
#     # ---- KEEP PLOT-LEVEL DATA (do NOT summarise here) ---- #
    # group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, MonStatus, SampleEventDate_Year) %>%
    # dplyr::mutate(
    #   n_species_ByPlot = n_distinct(Species.Symbol)) %>% 
    # group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, MonStatus, SampleEventDate_Year, Nativity) %>%
    # dplyr::mutate(
    #   n_species_ByPlotNativity = n_distinct(Species.Symbol)) %>%
    # group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, Macroplot, MonStatus, SampleEventDate_Year, Preferred_Lifeform) %>%
    # dplyr::mutate(
    #   n_species_ByPlotLifeform = n_distinct(Species.Symbol)) %>%
    # # ---- KEEP BURN UNIT-LEVEL DATA (do NOT summarise here) ---- #
    # group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, MonStatus, SampleEventDate_Year, Nativity) %>%
    # dplyr::mutate(
    #   n_species_ByNativity = n_distinct(Species.Symbol)) %>% 
    #   group_by(AdministrationUnit_Name, SampleEvent_TreatmentUnit, MonStatus, SampleEventDate_Year, Nativity) %>%
    # dplyr::mutate(
    #   n_species_ByLifeform = n_distinct(Species.Symbol)) %>% 
    # # ---- KEEP BURN UNIT-LEVEL DATA (do NOT summarise here) ---- #
    # ungroup()
}
```

```{r}
#HerbsPoints_sum <- calculate_Points_cover(HerbsPoints)
```
