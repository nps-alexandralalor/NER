---
title: "QAQC MetaData"
author: "Alexandra Lalor"
output:
  html_document:
    theme: readable
    highlight: 
    toc: yes
    toc_depth: 3
    toc_float:
      smooth_scroll: yes
    code_download: true
  pdf_document:
    toc: yes
    toc_depth: '3'
---

# BEFORE STARTING

This code is intended to combine FFI files into single flat files to be used with subsequent R scripts.

The combined Metadata file includes the Macroplot Report, Project Unit Assignment Report, and Sample Event Report. These reports can be downloaded via the Utilities menu on the Project Management tab on the FFI Remote App Server.

### Setup {.hidden}

```{r setup, include=FALSE}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE)
```

```{r install packages, include=FALSE}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("Rtools")
# install.packages("janitor")
# install.packages("condformat")
# install.packages("knitr")
# install.packages("here")
```

```{r load packages, include=FALSE}
## Load Packages

# tidyverse and dplyr have lots of useful functions for data cleaning
library(tidyverse)
library(dplyr)
library(plyr)
# janitor has functions to find duplicates
library(janitor)
# writexl is used to create excel output files
library(writexl)
# condformat is used to format excel output files
library(condformat)
# knitr is used to create output files from R Markdown
library(knitr)
# "here" helps you easily find and reference your working directory
library(here)
```

### Adjust File Paths {.hidden}

```{r}
# load in data.
path_main <- "C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/"
parks <- c("ANTI", "APCO", "CATO", "CUVA", "DEWA", "FRSP", "GATE", "GETT", "MONO", "NERI", "PRWI", "RICH", "SARA", "SHEN", "VAFO")
```

# METADATA REPORT: MERGE AND SAVE

```{r}
for(i in parks) {
  # select target park
  target_park <- i
  
  
  # adjust file paths
  path_data <- paste0(path_main, "Exports/", target_park, "/", target_park, "_")
  path_save <- paste0(path_main, "R Outputs/", target_park, "/")
  
  
  # load data
  MacroplotReport <- read.csv(paste0(path_data, "MacroplotReport.csv"), na.strings = c("","NA","N/A"))
  ProjectUnitReport <- read.csv(paste0(path_data, "ProjectUnitAssignmentReport.csv"), na.strings = c("","NA","N/A"))
  SampleEventReport <- read.csv(paste0(path_data, "SampleEventReport.csv"), na.strings = c("","NA","N/A"))
  
  
  # clean data
  #### Macroplot Report
  # The Macroplot Report contains information on both plot metadata and sample event history. Separate these into 2 tables.
  MacroplotReport_MetaData <- MacroplotReport %>%
    # remove trailing/leading whitespace
    mutate(across(where(is.character), str_trim)) %>%
    # separate tables
    filter(is.na(SampleEventDate)) %>%
    # separate Date columns into Date and Time columns
    separate(DateIn, sep = " ", into = c("DateIn", "DateInTime")) %>%
    separate(FutureVisit, sep = " ", into = c("FutureVisit", "FutureVisitTime")) %>%
    separate(DateOut, sep = " ", into = c("DateOut", "DateOutTime")) %>%
    # reformate Date columns
    mutate(DateIn = as.Date(DateIn, "%m/%d/%Y")) %>%
    mutate(FutureVisit = as.Date(FutureVisit, "%m/%d/%Y")) %>%
    mutate(DateOut = as.Date(DateOut, "%m/%d/%Y")) %>% 
    # separate Date columns into Year Month Day columns
    separate(DateIn, sep = "-", into = c("DateIn_Year", "Month", "Day"), remove = F) %>%
    separate(FutureVisit, sep = "-", into = c("FutureVisit_Year", "Month", "Day"), remove = F) %>%
    separate(DateOut, sep = "-", into = c("DateOut_Year", "Month", "Day"), remove = F) %>%
    # remove unnecessary columns
    select(!c(DateInTime, FutureVisitTime, DateOutTime, Month, Day)) %>%
    select(!c(SampleEventDate, SampleEventTeam, SampleEventComment, MonStatusOrd, LegacyMonStatus, MonStatus))
  
  MacroplotReport_SampleEvents <- MacroplotReport %>%
    # remove trailing/leading whitespace
    mutate(across(where(is.character), str_trim)) %>%
    # separate tables
    filter(!is.na(SampleEventDate)) %>%
    # separate Date columns into Date and Time columns
    separate(SampleEventDate, sep = " ", into = c("SampleEventDate", "SampleEventTime")) %>%
    # reformate Date columns
    mutate(SampleEventDate = as.Date(SampleEventDate, "%m/%d/%Y")) %>%
    separate(SampleEventDate, sep = "-", into = c("SampleEventDate_Year", "Month", "Day"), remove = F) %>%
    # remove unnecessary columns
    select(!c(SampleEventTime, Month, Day)) %>%
    select(c(Macroplot, SampleEventDate, SampleEventDate_Year, SampleEventTeam, SampleEventComment, MonStatusOrd, LegacyMonStatus, MonStatus))
  
  #### Sample Event Report
  # The Sample Event Report has different column names as the Macroplot Report, but contains the same information. Make column names consistent.
  SampleEventReport <- SampleEventReport %>%
    # remove trailing/leading whitespace
    mutate(across(where(is.character), str_trim)) %>%
    # make column names consistent
    mutate(Macroplot = MacroPlot_Name,
           LegacyMonitoringStatus = SampleEvent_LegacyMonitoringStatus,
           MonStatus = MonitoringStatus_Name,
           ProjectUnit = ProjectUnit_Name,
           SampleEventDate = SampleEvent_Date) %>%
    # separate Date columns into Date and Time columns
    separate(SampleEventDate, sep = " ", into = c("SampleEventDate", "SampleEventTime")) %>%
    # reformate Date columns
    mutate(SampleEventDate = as.Date(SampleEventDate, "%m/%d/%Y")) %>%
    separate(SampleEventDate, sep = "-", into = c("SampleEventDate_Year", "Month", "Day"), remove = F) %>%
    # remove unnecessary columns
    select(!c(SampleEventTime, Month, Day)) %>%
    select(!c(MacroPlot_Name, SampleEvent_LegacyMonitoringStatus, MonitoringStatus_Name, ProjectUnit_Name, SampleEvent_Date))
  
  
  # merge data
  #### Merge MacroplotReport_Metadata and MacroplotReport_SampleEvents
  MacroplotReport_merge <- merge(MacroplotReport_MetaData, MacroplotReport_SampleEvents, by = c("Macroplot")) %>%
    select(!MonStatusOrd)
  
  #### Filter Sample Event Report for merging
  SampleEventReport_merge <- SampleEventReport %>%
    filter(ProjectUnit != "ALL") %>% 
    select(!c(Multi_PU, LegacyMonitoringStatus))
  
  #### Merge Macroplot Report and Sample Event Report
  MetadataReport <- merge(MacroplotReport_merge, SampleEventReport_merge, by = c("Macroplot", "SampleEventDate", "SampleEventDate_Year", "MonStatus")) %>%
    relocate(AdministrationUnit_Name, .before = Macroplot) %>%
    relocate(ProjectUnit, .after = Purpose) %>%
    relocate(Type, .after = Purpose) %>% 
    relocate(Macroplot, .after = Type) %>%
    relocate(SampleEventDate, .after = Visited) %>%
    relocate(SampleEventDate_Year, .after = SampleEventDate) %>% 
    relocate(MonStatus, .after = LegacyMonStatus) %>%
    relocate(LocatedBy, .before = StartPoint)
  
  MetadataReport[] <- lapply(MetadataReport, function(x) gsub(",", ";", x))
  
  
  # save file
  write.csv(MetadataReport, paste0(path_save, target_park, "_MetadataReport.csv"), quote = FALSE, row.names = FALSE) 
}
```
