---
title: "FFI Database Summary"
subtitle: "Northeast Region"
output: 
  html_document:
    toc: true
    toc-float: true
    code_download: true
date: "`r Sys.Date()`"
---

# Purpose

This report summarizes plot work by the NPS Fire Ecology Program. The included tables and graphs allow a user to quickly view the overall status of program, park, project, or protocol activities in an FFI admin unit.

The code summarizes records in the Macroplot Report and Sample Event Report that can be downloaded via the Utilities menu on the Project Management tab on the FFI Remote App Server. You can recreate this Metadata Report by running code found in the file "QAQC_MetadataReport.R", under the scripts folder for this R project.

### Setup

```{r}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE)
```

```{r}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("kableExtra")
# install.packages("ggplot2")
```

```{r}
## Load Packages

# "here" helps you easily find and reference your working directory
library(here)
# "tidyverse" has lots of useful functions for data cleaning
library(tidyverse)
# "kableExtra" is used to produce formatted tables
library(kableExtra)
library(ggplot2)
library(stringr)
library(DT)
library(fs)
```

```{r}
## Adjust File Paths
path_data <- paste0("C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/Exports/")
```

### Load Data

Load in the Metadata Report. This Metadata Report was created by combining Macroplot Reports and Sample Event Reports from each Admin Unit, which can be downloaded via the Utilities menu on the Project Management tab on the FFI Remote App Server.

```{r}
# Load in data
MetadataReport_ANTI <- read.csv(paste0(path_data, "ANTI/ANTI_MetadataReport.csv"), quote = "")
MetadataReport_APCO <- read.csv(paste0(path_data, "APCO/APCO_MetadataReport.csv"), quote = "")
MetadataReport_CATO <- read.csv(paste0(path_data, "CATO/CATO_MetadataReport.csv"), quote = "")
MetadataReport_CUVA <- read.csv(paste0(path_data, "CUVA/CUVA_MetadataReport.csv"), quote = "")
MetadataReport_DEWA <- read.csv(paste0(path_data, "DEWA/DEWA_MetadataReport.csv"), quote = "")
MetadataReport_FRSP <- read.csv(paste0(path_data, "FRSP/FRSP_MetadataReport.csv"), quote = "")
MetadataReport_GATE <- read.csv(paste0(path_data, "GATE/GATE_MetadataReport.csv"), quote = "")
MetadataReport_GETT <- read.csv(paste0(path_data, "GETT/GETT_MetadataReport.csv"), quote = "")
MetadataReport_MONO <- read.csv(paste0(path_data, "MONO/MONO_MetadataReport.csv"), quote = "")
MetadataReport_NERI <- read.csv(paste0(path_data, "NERI/NERI_MetadataReport.csv"), quote = "")
MetadataReport_PRWI <- read.csv(paste0(path_data, "PRWI/PRWI_MetadataReport.csv"), quote = "")
MetadataReport_RICH <- read.csv(paste0(path_data, "RICH/RICH_MetadataReport.csv"), quote = "")
MetadataReport_SARA <- read.csv(paste0(path_data, "SARA/SARA_MetadataReport.csv"), quote = "")
MetadataReport_SHEN <- read.csv(paste0(path_data, "SHEN/SHEN_MetadataReport.csv"), quote = "")
MetadataReport_VAFO <- read.csv(paste0(path_data, "VAFO/VAFO_MetadataReport.csv"), quote = "")
```

### Merge Data

```{r}
#MetadataReport <- rbind(MetadataReport_ANTI, MetadataReport_APCO, MetadataReport_GETT, MetadataReport_RICH)

MetadataReport <- rbind(MetadataReport_ANTI, MetadataReport_APCO, MetadataReport_CATO, MetadataReport_CUVA, MetadataReport_DEWA, MetadataReport_FRSP, MetadataReport_GATE, MetadataReport_GETT, MetadataReport_MONO, MetadataReport_NERI, MetadataReport_PRWI, MetadataReport_RICH, MetadataReport_SARA, MetadataReport_SHEN, MetadataReport_VAFO)

remove(MetadataReport_ANTI, MetadataReport_APCO, MetadataReport_CATO, MetadataReport_CUVA, MetadataReport_DEWA, MetadataReport_FRSP, MetadataReport_GATE, MetadataReport_GETT, MetadataReport_MONO, MetadataReport_NERI, MetadataReport_PRWI, MetadataReport_RICH, MetadataReport_SARA, MetadataReport_SHEN, MetadataReport_VAFO)
```

### Target Park / Target Year

```{r set parameters, include=F}
### Select Data to Summarize 
# use commas to build lists of acceptable values for filters  
# designate target park(s) 
#unique(MetadataReport$AdministrationUnit_Name) 
target_park <- c("CATO", "GETT", "MONO", "NERI", "RICH", "SHEN")

# designate target year or years 
#unique(MetadataReport$SampleEventDate_Year) 
target_year <- c(2025)
```

# Grouping Tables

```{r}
table <- MetadataReport %>%
  mutate(Purpose_Code = ifelse(Purpose == "Fire Monitoring Handbook", "FMH",
                            ifelse(Purpose == "Inventory & Monitoring", "I&M",
                                   ifelse(Purpose == "Composite Burn Index", "CBI",
                                          ifelse(Purpose=="Rapid Assessment","RA",
                                                 ifelse(Purpose=="Fuels","Fuels",
                                                        "FMH")))))) %>%
  mutate(Purpose_Code = ifelse(is.na(Purpose_Code), "FMH", Purpose_Code)) %>% 
  mutate(Plot_Type = ifelse(Purpose_Code == "CBI", "CBI", paste0(Purpose_Code, " - ", Type))) %>% 
  # group_by(AdministrationUnit_Name) %>% 
  # mutate(n_total_plots_ByPark = n_distinct(Macroplot)) %>% 
  group_by(AdministrationUnit_Name, Plot_Type) %>%
  mutate(n_total_plots_ByParkPlotType = n_distinct(Macroplot)) %>% 
  group_by(AdministrationUnit_Name, Plot_Type, UV1) %>%
  mutate(n_total_plots_ByParkPlotTypeUV1 = n_distinct(Macroplot)) %>% 
  # group_by(AdministrationUnit_Name, Plot_Type, UV2) %>%
  # mutate(n_total_plots_ByParkPlotTypeUV2 = n_distinct(Macroplot)) %>% 
  group_by(AdministrationUnit_Name, Plot_Type, UV1, UV2) %>%
  mutate(n_total_plots_ByParkPlotTypeUV1UV2 = n_distinct(Macroplot)) %>% 
  ungroup()
```

### Group by Park and Plot Type

```{r}
# reduce to project summary with target year totals
table_a <- table %>% 
  group_by(AdministrationUnit_Name, Plot_Type, n_total_plots_ByParkPlotType) %>% 
  dplyr::summarise(first_year = min(SampleEventDate_Year),
                   last_year = max(SampleEventDate_Year),
                   n_current_yr_plots = n_distinct(Macroplot[SampleEventDate_Year == target_year])) %>% 
  select(AdministrationUnit_Name, Plot_Type, n_total_plots_ByParkPlotType, n_current_yr_plots)
```

### Group by Park, Plot Type, and Project Unit

```{r}
# reduce to project summary with target year totals
table_b <- table %>% 
  group_by(AdministrationUnit_Name, Plot_Type, UV1, n_total_plots_ByParkPlotTypeUV1) %>% 
  dplyr::summarise(first_year = min(SampleEventDate_Year),
                   last_year = max(SampleEventDate_Year),
                   n_current_yr_plots = n_distinct(Macroplot[SampleEventDate_Year == target_year]))
```

### Group by Park, Plot Type, Project Unit, and Monitoring Type

```{r}
# reduce to project summary with target year totals
table_c <- table %>%
  group_by(AdministrationUnit_Name, Plot_Type, UV1, UV2, n_total_plots_ByParkPlotTypeUV1UV2) %>%
  dplyr::summarise(first_year = min(SampleEventDate_Year),
                   last_year = max(SampleEventDate_Year),
                   n_current_yr_plots = n_distinct(Macroplot[SampleEventDate_Year == target_year]))  # designate current year
```

# Table 1. Fire Effects Plot Workload

The table below summarizes all projects with plots sampled in the current year.

### Table 1 Final Groupings

```{r}
table_c_ProjectUnit <- table_c %>% 
  filter(n_current_yr_plots > 0) %>% 
  group_by(AdministrationUnit_Name, Plot_Type) %>% 
  dplyr::summarise(UV1_UV2 = paste(na.omit(unique(UV1)), collapse = ", "),
                   .groups = "drop")

table_a_filter <- table_a %>% 
  select(AdministrationUnit_Name, Plot_Type, n_total_plots_ByParkPlotType)

table_b_filter <- table_b %>% 
  filter(n_current_yr_plots > 0)

table1_add <- merge(table_b_filter, table_a_filter) %>% 
  mutate(n_total_plots = ifelse(Plot_Type == "I&M - Forest", 
                                n_total_plots_ByParkPlotTypeUV1,
                                n_total_plots_ByParkPlotType)) %>% 
  select(!c(n_total_plots_ByParkPlotType, n_total_plots_ByParkPlotTypeUV1))

table1 <- merge(table1_add, table_c_ProjectUnit) %>% 
  mutate(UV1 = UV1_UV2) %>%
  select(!c(UV1_UV2))
```

```{r year summ}
## Summarise yearly plot activity
target_year_summ <- table1 %>% 
  group_by(AdministrationUnit_Name, UV1, Plot_Type) %>%
  dplyr::summarise(Years = paste0(first_year, "-", last_year),
                   Annual_Total = n_current_yr_plots,
                   Total_Plots = n_total_plots,
                   .groups = "drop") %>%
  arrange(AdministrationUnit_Name, Plot_Type) %>% 
  mutate_all(as.character)

# Calculate totals
year_summ_totals <- target_year_summ %>%
  mutate(AdministrationUnit_Name = "Total",
         UV1 = "",
         Plot_Type = "",
         Years = "",
         Annual_Total = sum(as.numeric(Annual_Total)),
         Total_Plots = sum(as.numeric(Total_Plots))) %>% 
  mutate_all(as.character) %>% 
  slice_head()

# Bind the totals row to the original data frame
target_year_summ_w_totals <- bind_rows(target_year_summ, year_summ_totals)
names(target_year_summ_w_totals) <- c("Park", "Monitoring Unit", "Plot Type", "Years Data Collected<br>(start-end)", "Annual Total<br>(2025)", "Total Plots<br>(at park)")

target_year_summ_w_totals %>%
  kbl(escape = FALSE, # to render line break in column headers
      align = "lllccc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"),
                position = "left", fixed_thead = T) %>%
  row_spec(0, font_size = 14, bold = TRUE) %>%
  column_spec(3:6,extra_css = "vertical-align:middle;") %>% 
  row_spec(nrow(target_year_summ_w_totals), font_size = 14, bold = TRUE)
```

# Table B-1. All Fire Effects Plots Established

This table, found in Appendix B, summarizes the number of plots by type in each monitoring unit

### Table B-1 Final Groupings

```{r}
table_c_ProjectUnit <- table_c %>% 
  group_by(AdministrationUnit_Name, Plot_Type, UV1) %>% 
  dplyr::summarise(UV1_UV2 = paste(na.omit(UV2), collapse = ", "),
                   .groups = "drop")

table_b_filter <- table_b %>% 
  select(!(n_current_yr_plots))

tableB <- merge(table_b_filter, table_c_ProjectUnit) %>%
  mutate(UV1 = ifelse(UV1_UV2 != "", paste0(UV1, "<br>(", UV1_UV2, ")"), UV1)) %>%
  select(!c(UV1_UV2))
```

```{r all plot summ, warning=FALSE}

## Summarise plot activity
all_year_summ <- tableB %>% 
  group_by(AdministrationUnit_Name, UV1, Plot_Type) %>%
  dplyr::summarise(Years = paste0(first_year, "-", last_year),
                   Total_Plots = n_total_plots_ByParkPlotTypeUV1,
                   .groups = "drop") %>%
  arrange(AdministrationUnit_Name, Plot_Type) %>% 
  mutate_all(as.character)

# Calculate totals
all_year_summ_totals <- all_year_summ %>%
  mutate(AdministrationUnit_Name = "Total",
         UV1 = "",
         Plot_Type = "",
         Years = "",
         Total_Plots = sum(as.numeric(Total_Plots))) %>% 
  mutate_all(as.character) %>% 
  slice_head()

# Bind the totals row to the original data frame
all_year_summ_w_totals <- bind_rows(all_year_summ, all_year_summ_totals)
names(all_year_summ_w_totals) <- c("Park", "Monitoring Unit", "Plot Type", "Years Data Collected<br>(start-end)", "Total Plots<br>(at park)")

all_year_summ_w_totals %>%
  kbl(escape = FALSE, # to render line break in column headers
      align = "lllcc") %>%
  kable_styling(bootstrap_options = c("striped","condensed"),
                position = "left", fixed_thead = T) %>%
  row_spec(0, font_size = 14, bold = TRUE) %>%
  column_spec(3:5,extra_css = "vertical-align:middle;") %>% 
  row_spec(nrow(all_year_summ_w_totals), font_size = 14, bold = TRUE)

```
