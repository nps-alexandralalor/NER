---
title: "Park Report"
subtitle: Northeast Region
output:
  html_document:
    theme: readable
    highlight: null
    toc: false
    toc_depth: 2
    toc_float:
      smooth_scroll: true
    code_download: true
  pdf_document:
    toc: true
    toc_depth: 2
  word_document:
    toc: true
    toc_depth: 2
---

# Annual Report {.hidden}

### Setup {.hidden}

```{r}
## Markdown Options
knitr::opts_chunk$set(echo = FALSE, error = FALSE, warning = FALSE, message = FALSE)
```

```{r}
## Install packages (if needed)

# install.packages("tidyverse")
# install.packages("kableExtra")
# install.packages("ggplot2")
```

```{r}
## Load Packages

# "tidyverse" has lots of useful functions for data cleaning
library(tidyverse)
# "kableExtra" is used to produce formatted tables
library(kableExtra)
library(ggplot2)
library(stringr)
library(DT)
library(fs)
library(ggplot2)
library(patchwork)
```

### Adjust File Paths {.hidden}

```{r}
## Adjust File Paths
#path_file <- "E:/Allie/FireFX_NER/FFI Data Management/R Outputs/"
path_file <- "C:/Users/alalor/OneDrive - DOI/NER/FireFX/FFI Data Management/R Outputs/"
path_data <- paste0(path_file, "ALL/Calculations/ALL_")
```

### Load Data {.hidden}

```{r}
# Load in data
MetadataReport <- read.csv(paste0(path_data, "MetadataReport.csv"))
Fuels <- read.csv(paste0(path_data, "Data_Surface Fuels.csv"))
Trees <- read.csv(paste0(path_data, "Data_Trees-Seedlings.csv"))
Cover_Points <- read.csv(paste0(path_data, "Data_Cover_Points.csv"))
# Cover_SpComp <- read.csv(paste0(path_data, "Data_Cover_SpComp.csv"))
# PostBurn <- read.csv(paste0(path_data, "Data_Post Burn Severity (metric).csv"))
# Shrubs <- read.csv(paste0(path_data, "Data_Density - Belts (metric).csv"))
```

### Target Values {.hidden}

```{r}
target_park <- c("RICH")
target_type <- c("Forest")
target_years <- c(2025)
year_max <- as.numeric(format(Sys.Date(), "%Y"))
date_max <- as.Date(paste0(year_max, "-12-31"))

    MetadataReport_filter <- MetadataReport %>% 
      filter(
        AdministrationUnit_Name == target_park,
        Type == target_type
        )

    Fuels_filter <- Fuels %>% 
      filter(
        AdministrationUnit_Name == target_park,
        Type == target_type
        )

    Trees_filter <- Trees %>% 
      filter(
        AdministrationUnit_Name == target_park,
        Type == target_type
      )
    
    Cover_filter <- Cover_Points %>% 
      filter(
        AdministrationUnit_Name == target_park,
        Type == target_type
      )

year_min <- as.numeric((min(MetadataReport_filter$SampleEventDate_Year)) - 1)
date_min <- as.Date(paste0(year_min, "-12-31"))
#date_min <- as.Date((min(MetadataReport_filter$SampleEventDate)) - 365)

    MetadataReport_filter %>% 
      filter(Purpose == "Fire Monitoring Handbook") %>% 
      select(Macroplot_UV1, Macroplot_UV2) %>% 
      unique()

target_ProjectUnit <- c(
  "Cold Harbor I"
  #,"Cold Harbor II"
  )
target_MonitoringType <- c(
  "Pine Oak"
  )
```

# Background {.hidden}

# Methods {.hidden}

# Monitoring Objective Table {.hidden}

# Results Summary {.hidden}

# Graphs

## Disturbance History

### Prep {.hidden}

```{r}
Disturbances <- MetadataReport_filter %>% 
  filter(MonStatus %in% c("Burn", "Herbicide", "Mechanical", "Mow"))

Disturbances_graph <- Disturbances %>%
  group_by(
    Region, Zone, Unit, AdministrationUnit_Name, Plot_Type, 
    DisturbanceDate, DisturbanceDate_Year, SampleEventDate_Year, MonStatus
    ) %>%
  filter(
    DisturbanceDate_Year == SampleEventDate_Year
    ) %>%
  dplyr::summarize(
    n_Macroplot = n()
    ) %>%
  mutate(
    DisturbanceDate = as.Date(DisturbanceDate),
    Macroplot_Num = "All"
    ) %>%
  arrange(desc(MonStatus))
```

### Graph  {.hidden}

```{r}
p_disturbance <- MetadataReport_filter %>%
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType)
    ) %>%
  ggplot(aes(x = DisturbanceDate, y = Macroplot_Num)) +
  geom_line(aes(group = Macroplot_Num),
            data = Disturbances_graph) +
  geom_point(aes(X = DisturbanceDate, y = Macroplot_Num, fill = MonStatus),
             data = Disturbances_graph, shape = 21) +
  geom_line(aes(X = DisturbanceDate, y = Macroplot_Num, fill = MonStatus),
            data = Disturbances_graph) +
  geom_point(aes(X = DisturbanceDate, y = Macroplot_Num, fill = MonStatus),
             data = Disturbances_graph, shape = 21, size = 2.5) +
  facet_grid( ~ Macroplot_UV2) +
  labs(title = "Disturbance History",
       y = "",
       x = "Year",
       fill = "") +
  scale_x_date(
    limits = c(date_min, date_max),
    date_breaks = "1 year",
    date_labels = "%Y",
    expand = expansion(mult = c(0, 0))
  ) +
  theme_light() +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
        plot.title = element_text(size = 15, face="bold", hjust = 0.5),
        axis.title = element_text(size = 12, face="bold"),
        axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
        axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
        axis.text.y = element_blank(),
        axis.ticks.y = element_blank(),
        axis.text.x = element_text(size = 8, angle = 90, vjust = 0.5, hjust=1),
        legend.position = "top")

p_disturbance
```

## Surface Fuels

### Prep {.hidden}

```{r}
Fuels_graph <- Fuels_filter %>% 
  mutate(
    SampleEventDate_Year = as.numeric(SampleEventDate_Year)
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ) %>% 
  dplyr::summarise(
    n_plots = n_distinct(Macroplot),
    ThousHr_FuelLoad = mean(ThousHr_FuelLoad, na.rm = TRUE),
    ThousHrRott_FuelLoad = mean(ThousHrRott_FuelLoad, na.rm = TRUE),
    ThousHrSound_FuelLoad = mean(ThousHrSound_FuelLoad, na.rm = TRUE),
    Fine_FuelLoad = mean(Fine_FuelLoad, na.rm = TRUE),
    HunHr_FuelLoad = mean(HunHr_FuelLoad, na.rm = TRUE),
    TenHr_FuelLoad = mean(TenHr_FuelLoad, na.rm = TRUE),
    OneHr_FuelLoad = mean(OneHr_FuelLoad, na.rm = TRUE),
    Avg_LittDuff_FuelLoad = mean(Avg_LittDuff_FuelLoad, na.rm = TRUE),
    Avg_Litt_FuelLoad  = mean(Avg_Litt_FuelLoad, na.rm = TRUE),
    Avg_Duff_FuelLoad = mean(Avg_Duff_FuelLoad, na.rm = TRUE),
    .groups = "drop"
    ) %>% 
  pivot_longer(
    cols = c(
      ThousHr_FuelLoad,
      ThousHrRott_FuelLoad,
      ThousHrSound_FuelLoad,
      Fine_FuelLoad,
      HunHr_FuelLoad,
      TenHr_FuelLoad,
      OneHr_FuelLoad,
      Avg_LittDuff_FuelLoad,
      Avg_Litt_FuelLoad,
      Avg_Duff_FuelLoad
    ),
    names_to  = "FuelClass",
    values_to = "FuelLoad"
  ) %>% 
    mutate(
    FuelClass = factor(
      FuelClass,
      levels = c(
        "ThousHr_FuelLoad",
        "ThousHrRott_FuelLoad",
        "ThousHrSound_FuelLoad",
        "Fine_FuelLoad",
        "HunHr_FuelLoad",
        "TenHr_FuelLoad",
        "OneHr_FuelLoad",
        "Avg_LittDuff_FuelLoad",
        "Avg_Litt_FuelLoad",
        "Avg_Duff_FuelLoad"
      )
    )
  ) %>%
    mutate(
    FuelClass = recode(
      FuelClass,
      ThousHr_FuelLoad        = "1000-hr",
      ThousHrRott_FuelLoad    = "1000-hr Rotten",
      ThousHrSound_FuelLoad   = "1000-hr Sound",
      Fine_FuelLoad           = "Fine",
      HunHr_FuelLoad          = "100-hr",
      TenHr_FuelLoad          = "10-hr",
      OneHr_FuelLoad          = "1-hr",
      Avg_LittDuff_FuelLoad   = "Litter/Duff",
      Avg_Litt_FuelLoad       = "Litter",
      Avg_Duff_FuelLoad       = "Duff"
    )
  )
```

### Graph - 2025 Report Replicate

```{r}
p_fuels_classic <- Fuels_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType)
    ) %>%
  filter(FuelClass %in% c(
    #"1000-hr",
    #"1000-hr Rotten",
    #"1000-hr Sound",
    "Fine"
    #"100-hr",
    #"10-hr",
    #"1-hr",
    #"Litter/Duff",
    #"Litter",
    #"Duff"
  )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ) %>% 
  mutate(
    Total_FuelLoad = sum(FuelLoad)
    ) %>% 
  
  ggplot(aes(x = SampleEventDate_Year, y = FuelLoad, fill = FuelClass)) +
  geom_line() +
  geom_point() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Tons / Acre",
    fill = "Fuel Class",
    title = paste(target_park, target_type, "Fuel Loading")
  ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  ylim(0, 3) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    )

p_fuels_classic
```

### Graph - All Fuels {.hidden}

```{r}
p_fuels <- Fuels_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType)
    ) %>%
  filter(FuelClass %in% c(
    #"1000-hr",
    "1000-hr Rotten",
    "1000-hr Sound",
    #"Fine",
    "100-hr",
    "10-hr",
    "1-hr",
    #"Litter/Duff",
    "Litter",
    "Duff"
  )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ) %>% 
  mutate(
    Total_FuelLoad = sum(FuelLoad)
    ) %>% 
  
  ggplot() +
  geom_bar(aes(x = SampleEventDate_Year, y = FuelLoad, fill = FuelClass),
           position = "stack", stat = "identity") + 
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Tons / Acre",
    fill = "Fuel Class",
    title = paste(target_park, target_type, "Fuel Loading")
  ) +
  scale_x_continuous(
    limits = c((year_min), year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_fuels
```

### Graph - Merged

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Fuel Loading"),
    fill = "Disturbance"
       )

p_fuels_merge <- p_fuels +
  theme(plot.title = element_blank())

p_disturbance_merge / p_fuels_merge +
  plot_layout(heights = c(0.2, 1.4))
```

## Trees

### Prep {.hidden}

```{r}
Trees_graph <- Trees_filter %>% 
  mutate(
    SampleEventDate_Year = as.numeric(SampleEventDate_Year)
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Genus, Status
    ) %>%
  dplyr::summarise(
    n_plots = n_distinct(Macroplot),
    
    Seedling_Count  = sum(Seedling_Count),
    Seedling_Density_ac = round(mean(Seedling_Dens_ac, na.rm = TRUE)),
    #Seedling_Density_ha = round(mean(Seedling_Dens_ha, na.rm = TRUE)),
    
    Sapling_Count = sum(Sapling_Count),
    Sapling_Density_ac = round(mean(Sapling_Dens_ac, na.rm = TRUE)),
    #Sapling_Density_ha = round(mean(Sapling_Dens_ha, na.rm = TRUE)),
    
    Pole_Count = sum(Pole_Count),
    Pole_Density_ac = round(mean(Pole_Dens_ac, na.rm = TRUE)),
    #Pole_Density_ha = round(mean(Pole_Dens_ha, na.rm = TRUE)),
    
    Overstory_Count = sum(Overstory_Count),
    Overstory_Density_ac = round(mean(Overstory_Dens_ac, na.rm = TRUE)),
    #Overstory_Density_ha = round(mean(Overstory_Dens_ha, na.rm = TRUE)),
    
    .groups = "drop"
  ) %>% 
  pivot_longer(
    cols = matches("Seedling|Sapling|Pole|Overstory"),
    names_to = c("SizeClass", ".value"),
    names_pattern = "(Seedling|Sapling|Pole|Overstory)_(Count|Density)"
  ) %>% 
  mutate(
    SizeClass = factor(
      SizeClass,
      levels = c(
        "Overstory",
        "Pole",
        "Sapling",
        "Seedling"
      )
    ))
```

### Graph - 2025 Report Replicate

```{r}
p_trees_classic <- Trees_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    !Status %in% c("X","D")
    ) %>% 
  filter(SizeClass %in% c(
    #"Seedling",
    #"Sapling",
    "Pole"
    #"Overstory"
    )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ) %>% 
  mutate(
    Density = sum(Density)
    ) %>% 
    
  ggplot(aes(x = SampleEventDate_Year, y = Density)) +
  geom_line() +
  geom_point() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Stems / Acre",
    title = paste(target_park, target_type, "Pole Tree Density")
  ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    )

p_trees_classic
```

### Graph - Poles {.hidden}

```{r}
p_trees_poles <- Trees_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    !Status %in% c("X","D")
    ) %>% 
  filter(SizeClass %in% c(
    #"Seedling",
    #"Sapling",
    "Pole"
    #"Overstory"
    )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Genus, Status
    ) %>% 
  mutate(
    Density = sum(Density)
    ) %>% 
  filter(
    Density != 0
    ) %>% 
    
  ggplot() +
  geom_bar(
    aes(
      x = SampleEventDate_Year, 
      y = Density, 
      fill = Genus
      ),
    position = "stack", stat = "identity") +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Stems / Acre",
    title = paste(target_park, target_type, "Pole Tree Density")
    ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
    ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_trees_poles
```

### Graph - Seedlings {.hidden}

```{r}
p_trees_seedlings <- Trees_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    !Status %in% c("X","D")
    ) %>% 
  filter(SizeClass %in% c(
    "Seedling"
    #"Sapling",
    #"Pole",
    #"Overstory"
    )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Genus, Status
    ) %>% 
  mutate(
    Density = sum(Density)
    ) %>% 
  filter(
    Density != 0
    ) %>% 
    
  ggplot() +
  geom_bar(
    aes(
      x = SampleEventDate_Year, 
      y = Density, 
      fill = Genus
      ),
    position = "stack", stat = "identity") +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Stems / Acre",
    title = paste(target_park, target_type, "Seedling Tree Density")
  ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_trees_seedlings
```

### Graph - Saplings {.hidden}

```{r}
p_trees_saplings <- Trees_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    !Status %in% c("X","D")
    ) %>% 
  filter(SizeClass %in% c(
    #"Seedling",
    "Sapling"
    #"Pole",
    #"Overstory"
    )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Genus, Status) %>% 
  mutate(
    Density = sum(Density)
    ) %>% 
  filter(
    Density != 0
    ) %>% 
    
  ggplot() +
  geom_bar(
    aes(
      x = SampleEventDate_Year, 
      y = Density, 
      fill = Genus
      ),
    position = "stack", stat = "identity") +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Stems / Acre",
    title = paste(target_park, target_type, "Sapling Tree Density")
  ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_trees_saplings
```

### Graph - Overstory {.hidden}

```{r}
p_trees_overstory <- Trees_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    !Status %in% c("X","D")
    ) %>% 
  filter(SizeClass %in% c(
    #"Seedling",
    #"Sapling",
    #"Pole",
    "Overstory"
    )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Genus, Status
    ) %>% 
  mutate(
    Density = sum(Density)
    ) %>% 
  filter(
    Density != 0
    ) %>% 
    
  ggplot() +
  geom_bar(
    aes(
      x = SampleEventDate_Year, 
      y = Density, 
      fill = Genus
      ),
    position = "stack", stat = "identity") +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Stems / Acre",
    title = paste(target_park, target_type, "OVerstory Tree Density")
  ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_trees_overstory
```

### Graph - All {.hidden}

```{r}
p_trees_all <- Trees_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    !Status %in% c("X","D")
    ) %>% 
  filter(SizeClass %in% c(
    #"Seedling",
    "Sapling",
    "Pole",
    "Overstory"
    )) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Genus, Status, SizeClass) %>% 
  mutate(
    Density = sum(Density)
    ) %>% 
  filter(
    Density != 0
    ) %>% 
    
  ggplot() +
  geom_bar(
    aes(
      x = SampleEventDate_Year, 
      y = Density, 
      fill = SizeClass
      ),
    position = "stack", stat = "identity") +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "Stems / Acre",
    title = paste(target_park, target_type, "Tree Density")
  ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
  ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_trees_all
```

### Poles

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Pole Tree Density"),
    fill = "Disturbance"
       )

p_trees_merge <- p_trees_poles +
  theme(plot.title = element_blank())

p_disturbance_merge / p_trees_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### Seedlings

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Seedling Tree Density"),
    fill = "Disturbance"
       )

p_trees_merge <- p_trees_seedlings +
  theme(plot.title = element_blank())

p_disturbance_merge / p_trees_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### Saplings

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Sapling Tree Density"),
    fill = "Disturbance"
       )

p_trees_merge <- p_trees_saplings +
  theme(plot.title = element_blank())

p_disturbance_merge / p_trees_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### Overstory

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Overstory Tree Density"),
    fill = "Disturbance"
       )

p_trees_merge <- p_trees_overstory +
  theme(plot.title = element_blank())

p_disturbance_merge / p_trees_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### All Size Classes

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Tree Density"),
    fill = "Disturbance"
       )

p_trees_merge <- p_trees_all +
  theme(plot.title = element_blank())

p_disturbance_merge / p_trees_merge +
  plot_layout(heights = c(0.2, 1.4))
```

## Herbaceous

### Prep  {.hidden}

```{r}
Cover_graph <- Cover_filter %>% 
  mutate(
    SampleEventDate_Year = as.numeric(SampleEventDate_Year)
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type,
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Preferred_Lifeform, Genus, Nativity, Species.Symbol
    ) %>%
  dplyr::summarise(
    n_plots = n_distinct(Macroplot),
    Avg_Ht_m = round(mean(Avg_Ht_m, na.rm = TRUE), 1),
    Avg_Ht_ft = round(mean(Avg_Ht_ft, na.rm = TRUE), 1),
    PctCover = round(mean(PctCover, na.rm = TRUE), 2),
    .groups = "drop"
    ) %>% 
  mutate(
    Preferred_Lifeform = ifelse(Preferred_Lifeform == "Undefined", "Substrate", Preferred_Lifeform),
    Preferred_Lifeform = factor(
      Preferred_Lifeform,
      levels = c(
        "Tree",
        "Shrub",
        "Subshrub",
        "Forb/herb",
        "Fern",
        "Vine",
        "Graminoid",
        "Grass-like",
        "Nonvascular", 
        "Lichenous", 
        "Substrate"
      )))
```

### Graph - 2025 Report Replicate

```{r}
p_cover_classic <- Cover_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    Preferred_Lifeform %in% c(
      #"Nonvascular", "Lichenous", 
      "Graminoid", "Grass-like"
      #"Forb/herb", "Fern", "Vine",
      #"Shrub", "Subshrub",
      #"Tree",
      #"Substrate"
      ),
    Nativity %in% c(
      "Native"
      #"Non-Native",
      #"Invasive",
      #"Unknown"
      )
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    #,Preferred_Lifeform, Genus, Nativity
    ) %>% 
  mutate(
    Total_Cover = sum(PctCover)
    ) %>%  

  
  ggplot(aes(x = SampleEventDate_Year, y = Total_Cover)) +
  geom_line() +
  geom_point() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "% Cover",
    title = paste(target_park, target_type, "Native Grass Cover")
    ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
    ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    )

p_cover_classic
```

### Graph - Points Merged  {.hidden}

```{r}
p_cover_points <- Cover_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    Preferred_Lifeform %in% c(
      #"Nonvascular", "Lichenous", 
      "Graminoid", "Grass-like"
      #"Forb/herb", "Fern", "Vine",
      #"Shrub", "Subshrub",
      #"Tree",
      #"Substrate"
      ),
    Nativity %in% c(
      "Native"
      #"Non-Native",
      #"Invasive",
      #"Unknown"
      )
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Preferred_Lifeform
    ,Genus
    ,Nativity
    ,Species.Symbol
    ) %>% 
  dplyr::summarise(
    Total_Cover = sum(PctCover, na.rm = TRUE),
    .groups = "drop"
    ) %>%  
  
  ggplot(aes(
      x = SampleEventDate_Year, 
      y = Total_Cover, 
      fill = Genus
      )) +
  geom_col() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "% Cover",
    title = paste(target_park, target_type, "Native Grass Cover")
    ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
    ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_cover_points
```

```{r}

```

### Graph - Points Lifeform  {.hidden}

```{r}
p_cover_lifeform <- Cover_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    Preferred_Lifeform %in% c(
      "Nonvascular", "Lichenous", 
      "Graminoid", "Grass-like",
      "Forb/herb", "Fern", "Vine",
      "Shrub", "Subshrub",
      "Tree",
      "Substrate"
      ),
    Nativity %in% c(
      "Native",
      "Non-Native",
      "Invasive",
      "Unknown"
      )
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Preferred_Lifeform
    ,Genus
    ,Nativity
    ,Species.Symbol
    ) %>% 
  dplyr::summarise(
    Total_Cover = sum(PctCover, na.rm = TRUE),
    .groups = "drop"
    ) %>%  
  
  ggplot(aes(
      x = SampleEventDate_Year, 
      y = Total_Cover, 
      fill = Preferred_Lifeform
      )) +
  geom_col() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "% Cover",
    fill = "Lifeform",
    title = paste(target_park, target_type, "Cover")
    ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
    ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_cover_lifeform
```

### Graph - Points Nativity  {.hidden}

```{r}
p_cover_nativity <- Cover_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    Preferred_Lifeform %in% c(
      "Nonvascular", "Lichenous", 
      "Graminoid", "Grass-like",
      "Forb/herb", "Fern", "Vine",
      "Shrub", "Subshrub",
      "Tree"
      #"Substrate"
      ),
    Nativity %in% c(
      "Native",
      "Non-Native",
      "Invasive"
      #"Unknown"
      )
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Preferred_Lifeform
    ,Genus
    ,Nativity
    ,Species.Symbol
    ) %>% 
  dplyr::summarise(
    Total_Cover = sum(PctCover, na.rm = TRUE),
    .groups = "drop"
    ) %>%  
  
  ggplot(aes(
      x = SampleEventDate_Year, 
      y = Total_Cover, 
      fill = Nativity
      )) +
  geom_col() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "% Cover",
    fill = "Lifeform",
    title = paste(target_park, target_type, "Native Cover")
    ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
    ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_cover_nativity
```

### Graph - Points Oaks  {.hidden}

```{r}
p_cover_oaks <- Cover_graph %>% 
  filter(
    Macroplot_UV1 %in% c(target_ProjectUnit),
    Macroplot_UV2 %in% c(target_MonitoringType),
    Preferred_Lifeform %in% c(
      #"Nonvascular", "Lichenous", 
      #"Graminoid", "Grass-like",
      #"Forb/herb", "Fern", "Vine",
      #"Shrub", "Subshrub",
      "Tree"
      #"Substrate"
      ),
    Nativity %in% c(
      "Native",
      "Non-Native",
      "Invasive"
      #"Unknown"
      ),
    Genus == "Quercus"
    ) %>% 
  group_by(
    AdministrationUnit_Name, Purpose, Type, 
    Macroplot_UV1, Macroplot_UV2, MonStatus, SampleEventDate_Year
    ,Preferred_Lifeform
    ,Genus
    ,Nativity
    ,Species.Symbol
    ) %>% 
  dplyr::summarise(
    Total_Cover = sum(PctCover, na.rm = TRUE),
    .groups = "drop"
    ) %>%  
  
  ggplot(aes(
      x = SampleEventDate_Year, 
      y = Total_Cover, 
      fill = Species.Symbol
      )) +
  geom_col() +
  facet_wrap( ~ Macroplot_UV1, ncol = 1) +
  labs(
    x = "Year",
    y = "% Cover",
    fill = "Lifeform",
    title = paste(target_park, target_type, "Oak Cover")
    ) +
  scale_x_continuous(
    limits = c(year_min, year_max),
    breaks = seq(year_min, year_max, by = 1),
    expand = expansion(mult = c(0, 0))
    ) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(size = 8, angle = 90, hjust = 0.5, vjust = 0.5),
    plot.title = element_text(size = 15, face="bold", hjust = 0.5),
    plot.subtitle = element_text(size = 10, face="bold", hjust = 0.5),
    axis.title = element_text(size = 12, face="bold"),
    axis.title.y = element_text(margin = unit(c(0,4,0,0), "mm")),
    axis.title.x = element_text(margin = unit(c(4,0,0,0), "mm")),
    axis.text.y = element_text(size = 8),
    panel.grid.minor = element_blank()
    ) +
  geom_vline(
    xintercept = (MetadataReport_filter$DisturbanceDate_Year) - 0.5, 
    linetype = "dashed", 
    color = "red"
    )

#p_cover_oaks
```

### Cover Points

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Native Grass Cover"),
    fill = "Disturbance"
       )

p_cover_merge <- p_cover_points +
  theme(plot.title = element_blank())

p_disturbance_merge / p_cover_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### Cover Lifeform

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Cover"),
    fill = "Disturbance"
       )

p_cover_merge <- p_cover_lifeform +
  theme(plot.title = element_blank())

p_disturbance_merge / p_cover_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### Cover Nativity

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Native Cover"),
    fill = "Disturbance"
       )

p_cover_merge <- p_cover_nativity +
  theme(plot.title = element_blank())

p_disturbance_merge / p_cover_merge +
  plot_layout(heights = c(0.2, 1.4))
```

### Cover Oaks

```{r}
p_disturbance_merge <- p_disturbance +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.ticks.x = element_blank(),
        legend.position = "right",
        plot.margin = margin(t = 5, r = 5, b = 0, l = 5)
        )+
  labs(
    title = paste(target_park, target_type, "Oak Cover"),
    fill = "Disturbance"
       )

p_cover_merge <- p_cover_oaks +
  theme(plot.title = element_blank())

p_disturbance_merge / p_cover_merge +
  plot_layout(heights = c(0.2, 1.4))
```

## Herbs Species Comp

```{r}
# HerbsSpComp_graph <- HerbsSpComp %>%
#   filter(AdministrationUnit_Name == target_park,
#          Type == target_type) %>%
#   # group_by(AdministrationUnit_Name, Purpose, Type, MacroPlot.UV1, MonStatus, SampleEventDate_Year, Nativity) %>%
#   dplyr::summarise(n_species_ByNativity = mean(n_species_ByNativity),
#                    .groups = "drop")
```

```{r}
# HerbsSpComp_graph %>%
#   ggplot(aes(x = SampleEventDate_Year, y = n_species_ByNativity, fill = Nativity)) +
#   geom_bar(position = "stack", stat = "identity")
```

# Discussion  {.hidden}
